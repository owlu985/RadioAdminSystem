<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
{% include '_nav.html' %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="position-fixed top-0 start-50 translate-middle-x mt-3 d-inline-block" style="z-index: 1050; max-width: 90%;">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
        <script>
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    alert.classList.remove('show');
                });
            }, 2500);
        </script>
    {% endif %}
{% endwith %}

<!-- Pause Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1" aria-labelledby="pauseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pauseModalLabel">Pause Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="pauseForm" method="POST" action="{{ url_for('main.pause') }}">
                    <div class="mb-3">
                        <label for="pause_end_date" class="form-label">End Date for Pausing (optional)</label>
                        <input type="date" name="pause_end_date" id="pause_end_date" class="form-control">
                    </div>
                    <p>Are you sure you want to pause recordings?</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="pauseForm" class="btn btn-warning">Confirm Pause</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Settings</h2>
        <div class="d-flex gap-2 flex-wrap justify-content-end">
            <form action="{{ url_for('main.export_settings') }}" method="get" class="m-0">
                <button type="submit" class="btn btn-outline-primary" aria-label="Export settings JSON">
                    <i class="bi bi-download"></i> Export JSON
                </button>
            </form>
            <form action="{{ url_for('main.backup_settings_now') }}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-success" aria-label="Backup settings to disk">
                    <i class="bi bi-hdd"></i> Backup now
                </button>
            </form>
            <form action="{{ url_for('main.import_settings') }}" method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center m-0">
                <input type="file" name="settings_file" accept="application/json" class="form-control form-control-sm" aria-label="Choose settings JSON">
                <button type="submit" class="btn btn-outline-secondary btn-sm" aria-label="Import settings JSON">
                    <i class="bi bi-upload"></i> Import JSON
                </button>
            </form>
            {% if config.PAUSE_SHOWS_RECORDING == True %}
                <form action="{{ url_for('main.resume') }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-secondary" aria-label="Resume Recordings">
                        <i class="bi bi-play-circle"></i> Resume Recordings
                    </button>
                </form>
            {% else %}
                <a href="#" class="btn btn-secondary" aria-label="Pause Recordings" data-bs-toggle="modal" data-bs-target="#pauseModal">
                    <i class="bi bi-pause-circle"></i> Pause Recordings
                </a>
            {% endif %}
        </div>
    </div>
    <form method="post">
        <!-- Admin Username Field -->
        <div class="mb-3">
            <label for="admin_username" class="form-label">
                Admin Username
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The username used to log in as an admin."></i>
            </label>
            <input type="text" name="admin_username" id="admin_username" class="form-control" value="{{ admin_username }}" required>
        </div>
        
        <!-- Admin Password Field -->
        <div class="mb-3">
            <label for="admin_password" class="form-label">
                Admin Password
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The password for admin access. Keep this secure."></i>
            </label>
            <div class="input-group">
                <input type="password" name="admin_password" id="admin_password" class="form-control" value="{{ admin_password }}" required>
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()">Show/Hide</button>
            </div>
        </div>
        
        <!-- Stream URL Field -->
        <div class="mb-3">
            <label for="stream_url" class="form-label">
                Stream URL
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The URL of the stream to be recorded."></i>
            </label>
            <input type="text" name="stream_url" id="stream_url" class="form-control" value="{{ stream_url }}" required>
        </div>
        
        <!-- Output Folder Field -->
        <div class="mb-3">
            <label for="output_folder" class="form-label">
                Output Folder
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The folder where recordings will be saved. This is the server path. DO NOT change this if you dont know what you are doing."></i>
            </label>
            <input type="text" name="output_folder" id="output_folder" class="form-control" value="{{ output_folder }}" required>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <label for="settings_backup_interval_hours" class="form-label">Settings Backup Interval (hours)</label>
                <input type="number" min="1" name="settings_backup_interval_hours" id="settings_backup_interval_hours" class="form-control" value="{{ settings_backup_interval_hours }}">
            </div>
            <div class="col-md-4">
                <label for="settings_backup_retention" class="form-label">Backup Retention (files)</label>
                <input type="number" min="1" name="settings_backup_retention" id="settings_backup_retention" class="form-control" value="{{ settings_backup_retention }}">
            </div>
            <div class="col-md-4">
                <label for="theme_default" class="form-label">Default Theme</label>
                <select name="theme_default" id="theme_default" class="form-select">
                    <option value="system" {% if theme_default=='system' %}selected{% endif %}>System</option>
                    <option value="light" {% if theme_default=='light' %}selected{% endif %}>Light</option>
                    <option value="dark" {% if theme_default=='dark' %}selected{% endif %}>Dark</option>
                </select>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="inline_help_enabled" name="inline_help_enabled" {% if inline_help_enabled %}checked{% endif %}>
                    <label class="form-check-label" for="inline_help_enabled">Show inline help tips</label>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="station_name" class="form-label">
                Station Name
            </label>
            <input type="text" name="station_name" id="station_name" class="form-control" value="{{ station_name }}" required>
        </div>
        <div class="mb-3">
            <label for="station_slogan" class="form-label">
                Station Slogan
            </label>
            <input type="text" name="station_slogan" id="station_slogan" class="form-control" value="{{ station_slogan }}" required>
        </div>
        <div class="mb-3">
            <label for="station_background" class="form-label">
                Station Background (filename in static/ or full URL)
            </label>
            <input type="text" name="station_background" id="station_background" class="form-control" value="{{ station_background }}" placeholder="e.g. first-bkg-variant.jpg or https://example.com/bg.jpg">
        </div>
        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">Weather (Tempest)</h5>
            <div class="mb-3">
                <label for="tempest_api_key" class="form-label">Tempest API Key</label>
                <input type="text" name="tempest_api_key" id="tempest_api_key" class="form-control" value="{{ tempest_api_key }}" placeholder="Enter Tempest API token">
                <div class="form-text">Required for DJ status weather cards.</div>
            </div>
            <div class="mb-0">
                <label for="tempest_station_id" class="form-label">Station ID</label>
                <input type="number" name="tempest_station_id" id="tempest_station_id" class="form-control" value="{{ tempest_station_id }}" min="1">
            </div>
        </div>
        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">Alerts (Stream / Dead Air)</h5>
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" role="switch" id="alerts_enabled" name="alerts_enabled" {% if alerts_enabled %}checked{% endif %}>
                <label class="form-check-label" for="alerts_enabled">Enable alerts</label>
            </div>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="alerts_dry_run" name="alerts_dry_run" {% if alerts_dry_run %}checked{% endif %}>
                <label class="form-check-label" for="alerts_dry_run">Simulate only (log instead of sending)</label>
            </div>
            <div class="mb-3">
                <label for="alerts_discord_webhook" class="form-label">Discord Webhook URL</label>
                <input type="text" name="alerts_discord_webhook" id="alerts_discord_webhook" class="form-control" value="{{ alerts_discord_webhook }}" placeholder="https://discord.com/api/webhooks/...">
                <div class="form-text">If set, alerts post to this webhook.</div>
            </div>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="alerts_email_enabled" name="alerts_email_enabled" {% if alerts_email_enabled %}checked{% endif %}>
                <label class="form-check-label" for="alerts_email_enabled">Send email alerts</label>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="alerts_email_to" class="form-label">Email To</label>
                    <input type="email" name="alerts_email_to" id="alerts_email_to" class="form-control" value="{{ alerts_email_to }}" placeholder="alerts@example.com">
                </div>
                <div class="col-md-6">
                    <label for="alerts_email_from" class="form-label">Email From</label>
                    <input type="email" name="alerts_email_from" id="alerts_email_from" class="form-control" value="{{ alerts_email_from }}" placeholder="rams@example.com">
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="alerts_smtp_server" class="form-label">SMTP Server</label>
                    <input type="text" name="alerts_smtp_server" id="alerts_smtp_server" class="form-control" value="{{ alerts_smtp_server }}" placeholder="smtp.example.com">
                </div>
                <div class="col-md-6">
                    <label for="alerts_smtp_port" class="form-label">SMTP Port</label>
                    <input type="number" name="alerts_smtp_port" id="alerts_smtp_port" class="form-control" value="{{ alerts_smtp_port }}" min="1">
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="alerts_smtp_username" class="form-label">SMTP Username</label>
                    <input type="text" name="alerts_smtp_username" id="alerts_smtp_username" class="form-control" value="{{ alerts_smtp_username }}">
                </div>
                <div class="col-md-6">
                    <label for="alerts_smtp_password" class="form-label">SMTP Password</label>
                    <input type="password" name="alerts_smtp_password" id="alerts_smtp_password" class="form-control" value="{{ alerts_smtp_password }}">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="alert_dead_air_threshold_minutes" class="form-label">Dead Air Threshold (minutes)</label>
                    <input type="number" name="alert_dead_air_threshold_minutes" id="alert_dead_air_threshold_minutes" class="form-control" value="{{ alert_dead_air_threshold_minutes }}" min="1">
                </div>
                <div class="col-md-4">
                    <label for="alert_stream_down_threshold_minutes" class="form-label">Stream Down Threshold (minutes)</label>
                    <input type="number" name="alert_stream_down_threshold_minutes" id="alert_stream_down_threshold_minutes" class="form-control" value="{{ alert_stream_down_threshold_minutes }}" min="1">
                </div>
                <div class="col-md-4">
                    <label for="alert_repeat_minutes" class="form-label">Repeat Cooldown (minutes)</label>
                    <input type="number" name="alert_repeat_minutes" id="alert_repeat_minutes" class="form-control" value="{{ alert_repeat_minutes }}" min="1">
                </div>
            </div>
        </div>

        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">Stream Monitoring (Icecast)</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="self_heal_enabled" name="self_heal_enabled" {% if self_heal_enabled %}checked{% endif %}>
                <label class="form-check-label" for="self_heal_enabled">Enable self-heal/restarts for probes & recordings</label>
            </div>
            <div class="mb-3">
                <label for="icecast_status_url" class="form-label">Icecast Status URL</label>
                <input type="text" name="icecast_status_url" id="icecast_status_url" class="form-control" value="{{ icecast_status_url }}" placeholder="https://host:port/admin/stats">
                <div class="form-text">Used to show listener counts on the dashboard.</div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="icecast_username" class="form-label">Icecast Admin Username</label>
                    <input type="text" name="icecast_username" id="icecast_username" class="form-control" value="{{ icecast_username }}" placeholder="admin">
                </div>
                <div class="col-md-6">
                    <label for="icecast_password" class="form-label">Icecast Admin Password</label>
                    <input type="password" name="icecast_password" id="icecast_password" class="form-control" value="{{ icecast_password }}">
                </div>
            </div>
            <div class="mb-0">
                <label for="icecast_mount" class="form-label">Mount Name (e.g., /stream)</label>
                <input type="text" name="icecast_mount" id="icecast_mount" class="form-control" value="{{ icecast_mount }}">
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label for="icecast_analytics_interval_minutes" class="form-label">Listener Sample Interval (minutes)</label>
                        <input type="number" min="1" class="form-control" name="icecast_analytics_interval_minutes" id="icecast_analytics_interval_minutes" value="{{ icecast_analytics_interval_minutes }}">
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">Metadata Enrichment (MusicBrainz)</h5>
            <div class="mb-0">
                <label for="musicbrainz_user_agent" class="form-label">User Agent (recommended format: AppName/Version (contact@example.com))</label>
                <input type="text" name="musicbrainz_user_agent" id="musicbrainz_user_agent" class="form-control" value="{{ musicbrainz_user_agent }}" placeholder="RAMS/1.0 (you@example.com)">
                <div class="form-text">Used when calling MusicBrainz to populate metadata/ISRC suggestions.</div>
            </div>
        </div>
        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">OAuth (Google)</h5>
            <div class="mb-3">
                <label for="oauth_client_id" class="form-label">Client ID</label>
                <input type="text" name="oauth_client_id" id="oauth_client_id" class="form-control" value="{{ oauth_client_id }}" placeholder="Google OAuth client ID">
            </div>
            <div class="mb-3">
                <label for="oauth_client_secret" class="form-label">Client Secret</label>
                <input type="text" name="oauth_client_secret" id="oauth_client_secret" class="form-control" value="{{ oauth_client_secret }}" placeholder="Google OAuth client secret">
            </div>
            <div class="mb-0">
                <label for="oauth_allowed_domain" class="form-label">Allowed Email Domain (optional)</label>
                <input type="text" name="oauth_allowed_domain" id="oauth_allowed_domain" class="form-control" value="{{ oauth_allowed_domain }}" placeholder="example.edu">
                <div class="form-text">Only emails from this domain may log in via OAuth.</div>
            </div>
        </div>
        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">OAuth (Discord)</h5>
            <div class="mb-3">
                <label for="discord_oauth_client_id" class="form-label">Client ID</label>
                <input type="text" name="discord_oauth_client_id" id="discord_oauth_client_id" class="form-control" value="{{ discord_oauth_client_id }}" placeholder="Discord application client ID">
            </div>
            <div class="mb-3">
                <label for="discord_oauth_client_secret" class="form-label">Client Secret</label>
                <input type="text" name="discord_oauth_client_secret" id="discord_oauth_client_secret" class="form-control" value="{{ discord_oauth_client_secret }}" placeholder="Discord application client secret">
            </div>
            <div class="mb-0">
                <label for="discord_allowed_guild_id" class="form-label">Allowed Guild ID (optional)</label>
                <input type="text" name="discord_allowed_guild_id" id="discord_allowed_guild_id" class="form-control" value="{{ discord_allowed_guild_id }}" placeholder="e.g. 123456789012345678">
                <div class="form-text">If set, only Discord users in this guild may log in.</div>
            </div>
        </div>

        <div class="mb-3 border rounded p-3 bg-light">
            <h5 class="mb-3">Roles & Access</h5>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="oauth_only" name="oauth_only" {% if oauth_only %}checked{% endif %}>
                <label class="form-check-label" for="oauth_only">OAuth-only admin login (disable password form)</label>
            </div>
            <label class="form-label">Custom Roles (comma-separated)</label>
            <input type="text" name="custom_roles" class="form-control" value="{{ custom_roles }}" placeholder="producer,engineering">
            <div class="form-text">Custom roles appear in the user management dropdown. Use permissions field per user to grant scopes.</div>
        </div>

        <!-- Default Dates Fields -->
        <div class="mb-3">
            <label for="default_start_date" class="form-label">
                Default Start Date
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The default start date for shows. Does not change existing shows"></i>
            </label>
            <input type="date" name="default_start_date" id="default_start_date" class="form-control" value="{{ default_start_date }}" required>
        </div>
        
        <div class="mb-3">
            <label for="default_end_date" class="form-label">
                Default End Date
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="The default end date for shows. Make sure this is after the default start date.  Does not change existing shows"></i>
            </label>
            <input type="date" name="default_end_date" id="default_end_date" class="form-control" value="{{ default_end_date }}" required>
        </div>
        
        <!-- Save Folder Option-->
        <div class="mb-3">
            <label for="auto_create_show_folders" class="form-label">
                Auto Create Show Folders
                <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" title="Automatically create folders for each show under the output directory. Ensure correct permissions are set."></i>
                <input type="checkbox" name="auto_create_show_folders" id="auto_create_show_folders" class="form-check-input" {% if auto_create_show_folders %}checked{% endif %}>
            </label>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Settings
        </button>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </form>
{% include '_footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    function togglePassword() {
        const passwordInput = document.getElementById("admin_password");
        passwordInput.type = passwordInput.type === "password" ? "text" : "password";
    }
</script>
</body>
</html>
