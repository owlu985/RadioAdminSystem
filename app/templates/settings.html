<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .tab-pane{display:none;}
        .tab-pane.active{display:block;}
        .settings-nav .nav-link{font-weight:500;}
        .helper-badge{font-size:0.85rem;}
    </style>
</head>
<body>
{% include '_nav.html' %}
<!-- Pause Modal -->
<div class="modal fade" id="pauseModal" tabindex="-1" aria-labelledby="pauseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pauseModalLabel">Pause Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="pauseForm" method="POST" action="{{ url_for('main.pause') }}">
                    <div class="mb-3">
                        <label for="pause_end_date" class="form-label">End Date for Pausing (optional)</label>
                        <input type="date" name="pause_end_date" id="pause_end_date" class="form-control">
                    </div>
                    <p>Are you sure you want to pause recordings?</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="pauseForm" class="btn btn-warning">Confirm Pause</button>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4 mb-5">
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3 gap-2">
        <div>
            <h2 class="mb-1">Settings</h2>
            <div class="text-muted">Use the tabs to find what you need faster.</div>
        </div>
        <div class="d-flex flex-wrap gap-2 justify-content-end">
            <form action="{{ url_for('main.export_settings') }}" method="get" class="m-0">
                <button type="submit" class="btn btn-outline-primary" aria-label="Export settings JSON"><i class="bi bi-download"></i> Export JSON</button>
            </form>
            <form action="{{ url_for('main.backup_settings_now') }}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-success" aria-label="Backup settings to disk"><i class="bi bi-hdd"></i> Backup now</button>
            </form>
            <form action="{{ url_for('main.backup_data_now') }}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-success" aria-label="Backup data to disk"><i class="bi bi-archive"></i> Backup data</button>
            </form>
            <form action="{{ url_for('main.import_settings') }}" method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center m-0">
                <input type="file" name="settings_file" accept="application/json" class="form-control form-control-sm" aria-label="Choose settings JSON">
                <button type="submit" class="btn btn-outline-secondary btn-sm" aria-label="Import settings JSON"><i class="bi bi-upload"></i> Import JSON</button>
            </form>
            {% if pause_shows_recording %}
                <form action="{{ url_for('main.resume') }}" method="POST" class="m-0">
                    <button type="submit" class="btn btn-secondary" aria-label="Resume Recordings">
                        <i class="bi bi-play-circle"></i> Resume Recordings
                    </button>
                </form>
            {% else %}
                <a href="#" class="btn btn-secondary" aria-label="Pause Recordings" data-bs-toggle="modal" data-bs-target="#pauseModal">
                    <i class="bi bi-pause-circle"></i> Pause Recordings
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="list-group settings-nav" id="settingsTab" role="tablist">
                <button class="list-group-item list-group-item-action active" data-target="#tab-general" type="button">General</button>
                <button class="list-group-item list-group-item-action" data-target="#tab-branding" type="button">Branding & UI</button>
                <button class="list-group-item list-group-item-action" data-target="#tab-stream" type="button">Stream & Alerts</button>
                <button class="list-group-item list-group-item-action" data-target="#tab-auth" type="button">Access & OAuth</button>
                <button class="list-group-item list-group-item-action" data-target="#tab-library" type="button">Library & News</button>
                <button class="list-group-item list-group-item-action" data-target="#tab-backup" type="button">Backups & Limits</button>
            </div>
        </div>
        <div class="col-md-9">
            <form method="post" enctype="multipart/form-data">
                <div id="tab-general" class="tab-pane active">
                    <div class="card mb-3">
                        <div class="card-header">Admin Access</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="admin_username" class="form-label">Admin Username</label>
                                <input type="text" name="admin_username" id="admin_username" class="form-control" value="{{ admin_username }}" required>
                            </div>
                            <div class="mb-0">
                                <label for="admin_password" class="form-label">Admin Password</label>
                                <div class="input-group">
                                    <input type="password" name="admin_password" id="admin_password" class="form-control" value="{{ admin_password }}" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()">Show/Hide</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">System Log</div>
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div class="text-muted">View the latest ShowRecorder log with color-coded severity.</div>
                            <a class="btn btn-outline-primary" href="{{ url_for('main.view_system_log') }}">Open Log Viewer</a>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">Server & Recording</div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="bind_host" class="form-label">Server Bind Host</label>
                                    <input type="text" name="bind_host" id="bind_host" class="form-control" value="{{ bind_host }}" required>
                                    <div class="form-text">127.0.0.1 for local-only, 0.0.0.0 to listen on LAN.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="bind_port" class="form-label">Server Port</label>
                                    <input type="number" min="1" max="65535" name="bind_port" id="bind_port" class="form-control" value="{{ bind_port }}" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="stream_url" class="form-label">Stream URL</label>
                                <input type="text" name="stream_url" id="stream_url" class="form-control" value="{{ stream_url }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="output_folder" class="form-label">Output Folder</label>
                                <input type="text" name="output_folder" id="output_folder" class="form-control" value="{{ output_folder }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="current_recording_period" class="form-label">Current Recording Period</label>
                                <select class="form-select" id="current_recording_period" name="current_recording_period">
                                    {% for period in recording_periods %}
                                        <option value="{{ period }}" {% if current_recording_period == period %}selected{% endif %}>{{ period }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">New recordings and logs will be saved in this period's folder.</div>
                            </div>
                            <div class="mb-3">
                                <label for="recording_periods" class="form-label">Recording Periods (one per line)</label>
                                <textarea class="form-control" id="recording_periods" name="recording_periods" rows="4">{{ recording_periods | join('\n') }}</textarea>
                                <div class="form-text">Add semesters or other periods here to make them available in the recordings list.</div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="default_start_date" class="form-label">Default Start Date</label>
                                    <input type="date" name="default_start_date" id="default_start_date" class="form-control" value="{{ default_start_date }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="default_end_date" class="form-label">Default End Date</label>
                                    <input type="date" name="default_end_date" id="default_end_date" class="form-control" value="{{ default_end_date }}" required>
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="auto_create_show_folders" id="auto_create_show_folders" {% if auto_create_show_folders %}checked{% endif %}>
                                <label class="form-check-label" for="auto_create_show_folders">Auto-create show folders</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-branding" class="tab-pane">
                    <div class="card mb-3">
                        <div class="card-header">Branding</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="station_name" class="form-label">Station Name</label>
                                <input type="text" name="station_name" id="station_name" class="form-control" value="{{ station_name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="station_slogan" class="form-label">Station Slogan</label>
                                <input type="text" name="station_slogan" id="station_slogan" class="form-control" value="{{ station_slogan }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="station_background" class="form-label">Station Background (filename or URL)</label>
                                <input type="text" name="station_background" id="station_background" class="form-control" value="{{ station_background }}" placeholder="first-bkg-variant.jpg or https://...">
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">UI & Accessibility</div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="theme_default" class="form-label">Default Theme</label>
                                    <select name="theme_default" id="theme_default" class="form-select">
                                        <option value="system" {% if theme_default=='system' %}selected{% endif %}>System</option>
                                        <option value="light" {% if theme_default=='light' %}selected{% endif %}>Light</option>
                                        <option value="dark" {% if theme_default=='dark' %}selected{% endif %}>Dark</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="font_scale_percent" class="form-label">Font scale (studio displays)</label>
                                    <input type="number" min="80" max="140" step="5" class="form-control" id="font_scale_percent" name="font_scale_percent" value="{{ font_scale_percent }}">
                                </div>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="inline_help_enabled" name="inline_help_enabled" {% if inline_help_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="inline_help_enabled">Show inline help tips</label>
                            </div>
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="high_contrast_default" name="high_contrast_default" {% if high_contrast_default %}checked{% endif %}>
                                <label class="form-check-label" for="high_contrast_default">High contrast by default</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-stream" class="tab-pane">
                    <div class="card mb-3">
                        <div class="card-header">Weather (Tempest)</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label for="tempest_api_key" class="form-label">Tempest API Key</label>
                                    <input type="text" name="tempest_api_key" id="tempest_api_key" class="form-control" value="{{ tempest_api_key }}" placeholder="Enter Tempest API token">
                                </div>
                                <div class="col-md-4">
                                    <label for="tempest_station_id" class="form-label">Station ID</label>
                                    <input type="number" name="tempest_station_id" id="tempest_station_id" class="form-control" value="{{ tempest_station_id }}" min="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">Stream Monitoring & Alerts</div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="icecast_status_url">Icecast Status URL</label>
                                    <input type="text" name="icecast_status_url" id="icecast_status_url" class="form-control" value="{{ icecast_status_url }}" placeholder="http://.../admin/stats">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="icecast_listclients_url">Icecast Listeners URL</label>
                                    <input type="text" name="icecast_listclients_url" id="icecast_listclients_url" class="form-control" value="{{ icecast_listclients_url }}" placeholder="http://.../admin/listclients?mount=/stream">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="icecast_username" class="form-label">Icecast Username</label>
                                    <input type="text" name="icecast_username" id="icecast_username" class="form-control" value="{{ icecast_username }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="icecast_password" class="form-label">Icecast Password</label>
                                    <input type="password" name="icecast_password" id="icecast_password" class="form-control" value="{{ icecast_password }}">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="icecast_mount" class="form-label">Mount</label>
                                    <input type="text" name="icecast_mount" id="icecast_mount" class="form-control" value="{{ icecast_mount }}" placeholder="/stream">
                                </div>
                                <div class="col-md-4">
                                    <label for="icecast_analytics_interval_minutes" class="form-label">Analytics Interval (min)</label>
                                    <input type="number" name="icecast_analytics_interval_minutes" id="icecast_analytics_interval_minutes" class="form-control" value="{{ icecast_analytics_interval_minutes }}" min="1">
                                </div>
                                <div class="col-md-4">
                                    <label for="icecast_ignored_ips" class="form-label">Ignored IPs</label>
                                    <input type="text" name="icecast_ignored_ips" id="icecast_ignored_ips" class="form-control" value="{{ icecast_ignored_ips }}" placeholder="comma-separated">
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="self_heal_enabled" name="self_heal_enabled" {% if self_heal_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="self_heal_enabled">Enable self-heal for probes/recorders</label>
                            </div>
                            <div class="border rounded p-3 bg-light">
                                <h6>Alerts</h6>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="alerts_enabled" name="alerts_enabled" {% if alerts_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="alerts_enabled">Enable alerts</label>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" role="switch" id="alerts_dry_run" name="alerts_dry_run" {% if alerts_dry_run %}checked{% endif %}>
                                    <label class="form-check-label" for="alerts_dry_run">Simulate only (log instead of sending)</label>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label for="alert_dead_air_threshold_minutes" class="form-label">Dead Air Minutes</label>
                                        <input type="number" name="alert_dead_air_threshold_minutes" id="alert_dead_air_threshold_minutes" class="form-control" value="{{ alert_dead_air_threshold_minutes }}" min="1">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="alert_stream_down_threshold_minutes" class="form-label">Stream Down Minutes</label>
                                        <input type="number" name="alert_stream_down_threshold_minutes" id="alert_stream_down_threshold_minutes" class="form-control" value="{{ alert_stream_down_threshold_minutes }}" min="1">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="alert_repeat_minutes" class="form-label">Repeat Every (minutes)</label>
                                        <input type="number" name="alert_repeat_minutes" id="alert_repeat_minutes" class="form-control" value="{{ alert_repeat_minutes }}" min="1">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="alerts_discord_webhook" class="form-label">Discord Webhook URL</label>
                                    <input type="text" name="alerts_discord_webhook" id="alerts_discord_webhook" class="form-control" value="{{ alerts_discord_webhook }}" placeholder="https://discord.com/api/webhooks/...">
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="alerts_email_enabled" name="alerts_email_enabled" {% if alerts_email_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="alerts_email_enabled">Send email alerts</label>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="alerts_email_to" class="form-label">Email To</label>
                                        <input type="email" name="alerts_email_to" id="alerts_email_to" class="form-control" value="{{ alerts_email_to }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="alerts_email_from" class="form-label">Email From</label>
                                        <input type="email" name="alerts_email_from" id="alerts_email_from" class="form-control" value="{{ alerts_email_from }}">
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label for="alerts_smtp_server" class="form-label">SMTP Server</label>
                                        <input type="text" name="alerts_smtp_server" id="alerts_smtp_server" class="form-control" value="{{ alerts_smtp_server }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="alerts_smtp_port" class="form-label">SMTP Port</label>
                                        <input type="number" name="alerts_smtp_port" id="alerts_smtp_port" class="form-control" value="{{ alerts_smtp_port }}" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="alerts_smtp_username" class="form-label">SMTP Username</label>
                                        <input type="text" name="alerts_smtp_username" id="alerts_smtp_username" class="form-control" value="{{ alerts_smtp_username }}">
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label for="alerts_smtp_password" class="form-label">SMTP Password</label>
                                    <input type="password" name="alerts_smtp_password" id="alerts_smtp_password" class="form-control" value="{{ alerts_smtp_password }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-auth" class="tab-pane">
                    <div class="card mb-3">
                        <div class="card-header">Rate Limiting</div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="rate_limit_enabled" name="rate_limit_enabled" {% if rate_limit_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="rate_limit_enabled">Enable Rate Limiting</label>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="rate_limit_requests" class="form-label">Requests per Window</label>
                                    <input type="number" min="1" name="rate_limit_requests" id="rate_limit_requests" class="form-control" value="{{ rate_limit_requests }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="rate_limit_window_seconds" class="form-label">Window (seconds)</label>
                                    <input type="number" min="1" name="rate_limit_window_seconds" id="rate_limit_window_seconds" class="form-control" value="{{ rate_limit_window_seconds }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="rate_limit_trusted_ips" class="form-label">Trusted IPs</label>
                                    <input type="text" name="rate_limit_trusted_ips" id="rate_limit_trusted_ips" class="form-control" value="{{ rate_limit_trusted_ips }}" placeholder="127.0.0.1, ::1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">OAuth (Google)</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="oauth_client_id" class="form-label">Client ID</label>
                                <input type="text" name="oauth_client_id" id="oauth_client_id" class="form-control" value="{{ oauth_client_id }}" placeholder="Google OAuth client ID">
                            </div>
                            <div class="mb-3">
                                <label for="oauth_client_secret" class="form-label">Client Secret</label>
                                <input type="text" name="oauth_client_secret" id="oauth_client_secret" class="form-control" value="{{ oauth_client_secret }}" placeholder="Google OAuth client secret">
                            </div>
                            <div class="mb-0">
                                <label for="oauth_allowed_domain" class="form-label">Allowed Email Domain (optional)</label>
                                <input type="text" name="oauth_allowed_domain" id="oauth_allowed_domain" class="form-control" value="{{ oauth_allowed_domain }}" placeholder="example.edu">
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">OAuth (Discord)</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="discord_oauth_client_id" class="form-label">Client ID</label>
                                <input type="text" name="discord_oauth_client_id" id="discord_oauth_client_id" class="form-control" value="{{ discord_oauth_client_id }}" placeholder="Discord application client ID">
                            </div>
                            <div class="mb-3">
                                <label for="discord_oauth_client_secret" class="form-label">Client Secret</label>
                                <input type="text" name="discord_oauth_client_secret" id="discord_oauth_client_secret" class="form-control" value="{{ discord_oauth_client_secret }}" placeholder="Discord application client secret">
                            </div>
                            <div class="mb-0">
                                <label for="discord_allowed_guild_id" class="form-label">Allowed Guild ID (optional)</label>
                                <input type="text" name="discord_allowed_guild_id" id="discord_allowed_guild_id" class="form-control" value="{{ discord_allowed_guild_id }}" placeholder="e.g. 123456789012345678">
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">Roles & Access</div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="oauth_only" name="oauth_only" {% if oauth_only %}checked{% endif %}>
                                <label class="form-check-label" for="oauth_only">OAuth-only admin login (disable password form)</label>
                            </div>
                            <label class="form-label">Custom Roles (comma-separated)</label>
                            <input type="text" name="custom_roles" class="form-control" value="{{ custom_roles }}" placeholder="producer,engineering">
                        </div>
                    </div>
                </div>

                <div id="tab-library" class="tab-pane">
                    <div class="card mb-3">
                        <div class="card-header">Music / Metadata</div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="musicbrainz_user_agent" class="form-label">MusicBrainz User-Agent</label>
                                    <input type="text" name="musicbrainz_user_agent" id="musicbrainz_user_agent" class="form-control" value="{{ musicbrainz_user_agent }}" placeholder="AppName/1.0 (you@example.com)">
                                </div>
                                <div class="col-md-6">
                                    <label for="data_root" class="form-label">RAMS Data Root</label>
                                    <input type="text" name="data_root" id="data_root" class="form-control" value="{{ data_root }}" placeholder="Path for RAMS data (uploads, hosted audio, logs)">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="music_library_path" class="form-label">Music Library Path</label>
                                    <input type="text" name="music_library_path" id="music_library_path" class="form-control" value="{{ music_library_path }}" placeholder="Path to main music library">
                                </div>
                                <div class="col-md-6">
                                    <label for="psa_library_path" class="form-label">PSA Library Path</label>
                                    <input type="text" name="psa_library_path" id="psa_library_path" class="form-control" value="{{ psa_library_path }}" placeholder="/path/to/psa/files">
                                </div>
                                <div class="col-md-6">
                                    <label for="imaging_library_path" class="form-label">Imaging Library Path</label>
                                    <input type="text" name="imaging_library_path" id="imaging_library_path" class="form-control" value="{{ imaging_library_path }}" placeholder="/path/to/imaging/files">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label class="form-label d-block">Music Library Index</label>
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <button type="button" class="btn btn-outline-secondary" id="libraryIndexRefresh">
                                            <i class="bi bi-arrow-repeat"></i> Force Refresh
                                        </button>
                                        <span class="text-muted small" id="libraryIndexRefreshStatus">
                                            Runs automatically every 12 hours.
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="radiodj_api_base_url" class="form-label">RadioDJ API Base URL</label>
                                    <input type="text" name="radiodj_api_base_url" id="radiodj_api_base_url" class="form-control" value="{{ radiodj_api_base_url }}" placeholder="http://127.0.0.1:7000">
                                </div>
                                <div class="col-md-6">
                                    <label for="radiodj_api_password" class="form-label">RadioDJ API Password</label>
                                    <input type="password" name="radiodj_api_password" id="radiodj_api_password" class="form-control" value="{{ radiodj_api_password }}" placeholder="RadioDJ API password">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="archivist_db_path" class="form-label">Archivist DB Path</label>
                                    <input type="text" name="archivist_db_path" id="archivist_db_path" class="form-control" value="{{ archivist_db_path }}" placeholder="/path/to/archivist.db">
                                </div>
                                <div class="col-md-6">
                                    <label for="archivist_upload_dir" class="form-label">Archivist Upload Directory</label>
                                    <input type="text" name="archivist_upload_dir" id="archivist_upload_dir" class="form-control" value="{{ archivist_upload_dir }}" placeholder="Folder for uploaded catalog CSVs">
                                </div>
                            </div>
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body">
                                    <h6 class="card-title mb-2">Archivist Catalog Import</h6>
                                    <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                                        <input type="file" name="archivist_file" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="form-control">
                                        <button type="submit" name="archivist_import" value="1" class="btn btn-outline-primary">Import CSV/TSV</button>
                                    </div>
                                    <div class="form-text mt-2">Imports Artist, Title, Album, Catalog, and PriceRange columns from the archivist catalog.</div>
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="audio_host_upload_dir" class="form-label">Hosted Audio Upload Directory</label>
                                    <input type="text" name="audio_host_upload_dir" id="audio_host_upload_dir" class="form-control" value="{{ audio_host_upload_dir }}" placeholder="/path/to/nas/hosted_audio">
                                </div>
                                <div class="col-md-6">
                                    <label for="audio_host_backdrop_default" class="form-label">Default Backdrop (path or URL)</label>
                                    <input type="text" name="audio_host_backdrop_default" id="audio_host_backdrop_default" class="form-control" value="{{ audio_host_backdrop_default }}" placeholder="Leave blank to use logo">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-backup" class="tab-pane">
                    <div class="card mb-3">
                        <div class="card-header">Backups & Retention</div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="settings_backup_interval_hours" class="form-label">Settings Backup Interval (hours)</label>
                                    <input type="number" min="1" name="settings_backup_interval_hours" id="settings_backup_interval_hours" class="form-control" value="{{ settings_backup_interval_hours }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="settings_backup_retention" class="form-label">Settings Backup Retention (files)</label>
                                    <input type="number" min="1" name="settings_backup_retention" id="settings_backup_retention" class="form-control" value="{{ settings_backup_retention }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="data_backup_retention_days" class="form-label">Data Backup Retention (days)</label>
                                    <input type="number" min="1" name="data_backup_retention_days" id="data_backup_retention_days" class="form-control" value="{{ data_backup_retention_days }}">
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="data_backup_dirname" class="form-label">Data Backup Folder Name</label>
                                    <input type="text" name="data_backup_dirname" id="data_backup_dirname" class="form-control" value="{{ data_backup_dirname }}">
                                    <small class="text-muted">Created under the instance folder; contains schedule/DJ/disciplinary snapshots.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button>
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% include '_footer.html' %}
<script>
    const tabButtons = document.querySelectorAll('#settingsTab button');
    const panes = document.querySelectorAll('.tab-pane');
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b=>b.classList.remove('active'));
            panes.forEach(p=>p.classList.remove('active'));
            btn.classList.add('active');
            const target = document.querySelector(btn.dataset.target);
            if(target){target.classList.add('active');}
        });
    });

    function togglePassword(){
        const passwordInput=document.getElementById('admin_password');
        passwordInput.type=passwordInput.type==='password'?'text':'password';
    }

    document.getElementById('link_generate').addEventListener('click', ()=>{
        const clientId=document.getElementById('link_client_id').value.trim();
        const redirect=document.getElementById('link_redirect').value.trim();
        const scopes=document.getElementById('link_scopes').value.trim().replace(/\s+/g,' ');
        const state=document.getElementById('link_state').value.trim()||'rams-state';
        const challenge=document.getElementById('link_challenge').value.trim();
        if(!clientId||!redirect||!scopes||!challenge){
            document.getElementById('link_output').value='Please fill client id, redirect, scopes, and code challenge.';
            return;
        }
        const params=new URLSearchParams({
            response_type:'code',
            client_id:clientId,
            redirect_uri:redirect,
            scope:scopes,
            state:state,
            code_challenge:challenge,
            code_challenge_method:'S256'
        });
        document.getElementById('link_output').value=`https://twitter.com/i/oauth2/authorize?${params.toString()}`;
    });

    const libraryIndexRefresh=document.getElementById('libraryIndexRefresh');
    const libraryIndexRefreshStatus=document.getElementById('libraryIndexRefreshStatus');
    if(libraryIndexRefresh){
        const originalLabel=libraryIndexRefresh.innerHTML;
        libraryIndexRefresh.addEventListener('click', async ()=>{
            libraryIndexRefresh.disabled=true;
            libraryIndexRefresh.innerHTML='<i class="bi bi-arrow-repeat"></i> Refreshing...';
            if(libraryIndexRefreshStatus){
                libraryIndexRefreshStatus.textContent='Requesting library refresh...';
            }
            try{
                const resp=await fetch('{{ url_for("api.library_index_refresh") }}', {
                    method:'POST',
                    credentials:'same-origin'
                });
                if(!resp.ok){
                    throw new Error('refresh failed');
                }
                const data=await resp.json();
                if(libraryIndexRefreshStatus){
                    libraryIndexRefreshStatus.textContent=data.started
                        ? 'Library indexing queued.'
                        : 'Library indexing already running.';
                }
            }catch(err){
                if(libraryIndexRefreshStatus){
                    libraryIndexRefreshStatus.textContent='Unable to start library index.';
                }
            }finally{
                libraryIndexRefresh.disabled=false;
                libraryIndexRefresh.innerHTML=originalLabel;
            }
        });
    }
</script>
</body>
</html>
