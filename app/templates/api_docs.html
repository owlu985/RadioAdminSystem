<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>API Documentation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
{% include '_nav.html' %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>API Documentation</h2>
        <a class="btn btn-secondary btn-sm" href="{{ url_for('main.dashboard') }}">Back to Dashboard</a>
    </div>

    <p class="text-muted">Base URL: <code>http://&lt;host&gt;:&lt;port&gt;</code></p>

    <h4 class="mt-4">Public & Website-Facing APIs</h4>
    <p class="text-muted">These endpoints are safe for the website and public widgets. For a quick index of every API, see the "Full Endpoint Index" section below.</p>
    <ul>
        <li><strong>Now Playing (widget-friendly):</strong>
            <pre><code>GET /api/now
GET /api/now/widget
GET /api/now/recent-tracks</code></pre>
            Returns current scheduled show or automation/off-air with run metadata. The widget variant returns a compact automation payload when off-schedule, using cached RadioDJ data when available. <code>/api/now/recent-tracks</code> returns the last 10 music log entries with cover image links.</li>
        <li><strong>Station Status (stream + probe):</strong>
            <pre><code>GET /api/stream/status</code></pre>
            Stream reachability, listener counts (Icecast), latest probe classification (live/auto/dead air), and dB ratios.</li>
        <li><strong>Schedule grid + calendar:</strong>
            <pre><code>GET /api/schedule</code></pre>
            <pre><code>GET /schedule/grid   (public HTML)
GET /schedule/ical   (iCal feed)</code></pre>
            Returns the weekly schedule for the website’s interactive grid and calendar exports.</li>
        <li><strong>Website content (plugin):</strong>
            <pre><code>GET /api/plugins/website/content</code></pre>
            Front-page hero, ordered articles, podcasts, and press features for the website.</li>
          <li>
            <pre><code>GET /api/plugins/website/banner</code></pre>
            Optional banner message for the website header; returns 204 when unset.</li>
        <li><strong>Hosted audio embeds (plugin):</strong>
            <pre><code>GET /api/plugins/audio/embed/&lt;id&gt;</code></pre>
            Returns a slim iframe-friendly player with RAMS backdrop for interviews/segments hosted in RAMS.</li>
        <li><strong>DJs:</strong>
            <pre><code>GET /api/djs</code></pre>
            DJ bios with photo URLs and the shows they host.</li>
        <li><strong>Tempest Weather:</strong>
            <pre><code>GET /api/weather/tempest</code></pre>
            Current conditions plus 1/2/4/8-hour snapshots and 3-day outlook (Tempest API key + station required).</li>
        <li><strong>Logs (public form):</strong>
            <pre><code>GET  /logs/submit
POST /logs/submit</code></pre>
            Public DJ log submission form; uses dropdown DJs/shows and required fields.</li>
        <li><strong>Log view/exports:</strong>
            <pre><code>GET /logs/view?sheet_id=&lt;id&gt;
GET /logs/download/csv?sheet_id=&lt;id&gt;
GET /logs/download/docx?sheet_id=&lt;id&gt;</code></pre>
        </li>
        <li><strong>DJ Status screen:</strong>
            <pre><code>GET /dj/status</code></pre>
            Full-screen clock + weather + station status for studio displays.</li>
        <li><strong>Media library (player queue):</strong>
            <pre><code>GET /api/psa/library
GET /api/psa/metadata?token=&lt;token&gt;
PATCH /api/psa/metadata?token=&lt;token&gt;
GET /api/psa/metadata/export?kind=psa|imaging|all
POST /api/psa/metadata/import
</code></pre>
            Paginated media library (PSA/music/assets/voice tracks) with categories, cues, and filters (<code>page</code>, <code>per_page</code>, <code>category</code>, <code>q</code>); used by the show automator queue.</li>
        <li><strong>Public AutoDJ control:</strong>
            <pre><code>GET  /dj/autodj
POST /api/radiodj/autodj</code></pre>
            No-login AutoDJ toggle page and API; dead-air auto-recovery re-enables AutoDJ after 4 minutes.</li>
    </ul>

    <h4 class="mt-4">Stream Monitoring & Probes</h4>
    <pre><code>POST /api/probe                 (trigger probe)
GET  /api/probes/latest        (latest probe)
GET  /api/runs/&lt;run_id&gt;
GET  /api/runs/&lt;run_id&gt;/logs
GET  /api/psa/compliance/&lt;run_id&gt;
GET  /api/reports/artist-frequency?show_run_id=&lt;id&gt;&amp;start=...&amp;end=...
POST /api/audit/start          (recording + explicitness audits)
GET  /api/audit/status/&lt;job_id&gt;</code></pre>
    <p>Probes classify live/automation/dead-air and log dB ratios. Audit jobs run in the background with progress polling.</p>

    <h4 class="mt-4">Music Library</h4>
    <pre><code>GET    /api/music/search?q=&lt;query&gt;&amp;page=1&amp;per_page=50&amp;folder=&lt;rel&gt;  (use q=% to list all)
GET    /api/music/detail?path=&lt;abs_path&gt;
GET    /api/music/cover-image?path=&lt;abs_path&gt;
POST   /api/music/cover-art                   (harvest/embed cover art)
GET    /api/music/musicbrainz?title=&lt;t&gt;&amp;artist=&lt;a&gt;&amp;limit=5
POST   /api/music/bulk-update                 (batch tag edits)
POST   /api/music/scan/library                (re-scan library & queues)
GET/POST /api/music/cue                       (get/set cue points)
GET/POST/DELETE /api/music/saved-searches     (save/load/delete searches)
POST   /api/archivist/album-rip               (analyze album rip for breaks)
GET    /api/archivist/album-info              (lookup album metadata)
POST   /api/music/musicbrainz                 (same as GET; lookup helper)</code></pre>
    <p>Detail responses include title/artist/album/composer/ISRC/year/track/disc/copyright/path, loudness/peaks, and cue data where available.</p>

    <h4 class="mt-4">RadioDJ Integration</h4>
    <pre><code>GET    /api/now/widget            (uses cached RadioDJ now-playing when off-schedule)
GET    /api/now/recent-tracks
GET    /api/radiodj/psas
POST   /api/radiodj/psas/&lt;psa_id&gt;/enable
POST   /api/radiodj/psas/&lt;psa_id&gt;/disable
DELETE /api/radiodj/psas/&lt;psa_id&gt;
PATCH  /api/radiodj/psas/&lt;psa_id&gt;/metadata   (JSON body)
POST   /api/radiodj/import/news
POST   /api/radiodj/import/community_calendar</code></pre>
    <p>Requires <code>RADIODJ_API_BASE_URL</code> and <code>RADIODJ_API_PASSWORD</code> plus the RadioDJ plugin configured.</p>

    <h4 class="mt-4">Schedule & Marathon Recording</h4>
    <pre><code>GET  /api/schedule                (JSON grid)
GET  /schedule/grid              (HTML)
GET  /schedule/ical              (iCal feed)
POST /marathon                   (admin form to schedule 24–48h marathon chunks)</code></pre>

    <h4 class="mt-4">Icecast Analytics</h4>
    <pre><code>GET /api/icecast/analytics</code></pre>
    <p>Returns listener counts with optional per-IP filtering using <code>ICECAST_IGNORED_IPS</code> and <code>ICECAST_LISTCLIENTS_URL</code>.</p>

    <h4 class="mt-4">News & Uploads</h4>
    <pre><code>GET/POST /news/upload            (auth form, supports multiple news types)
POST    /api/radiodj/import/news
POST    /api/radiodj/import/community_calendar</code></pre>

    <h4 class="mt-4">Logs, Absences, Discipline</h4>
    <pre><code>GET/POST /logs/submit            (public log form)
GET     /logs/manage            (admin)
GET     /logs/view?sheet_id=&lt;id&gt;
GET     /logs/download/csv?sheet_id=&lt;id&gt;
GET     /logs/download/docx?sheet_id=&lt;id&gt;
GET/POST /dj/absence            (DJ self-report)
GET/POST /absences              (admin manage/filter)
GET/POST /djs/discipline        (management only)
GET      /djs/&lt;id&gt;              (DJ profile)</code></pre>

    <h4 class="mt-4">Auth & OAuth</h4>
    <pre><code>GET /api/oauth/last-token        (admin-only, returns last OAuth token captured this session)
GET /api/oauth/x-token          (admin-only, returns the last Twitter/X OAuth token captured via PKCE flow)</code></pre>
    <p>Used for debugging OAuth flows (Google/Discord/Twitter); requires an authenticated admin session.</p>

    <h4 class="mt-4">Social & Live Reads</h4>
    <pre><code>GET/POST /production/live-reads          (card creation + print)
GET/POST /social/post                   (multi-network posting console)</code></pre>

    <h4 class="mt-4">Settings, Backup, Auth</h4>
    <pre><code>GET/POST /settings                       (branding, OAuth, alerts, stream, etc.)
GET      /settings/export               (JSON)
POST     /settings/import               (JSON)
POST     /settings/backup-now           (settings backup)
POST     /settings/backup-data          (JSON backups of DJs/shows/discipline)
GET      /login                         (OAuth-first)
GET/POST /login/master                  (master password)
GET      /logout</code></pre>

    <h4 class="mt-4">Full Endpoint Index</h4>
    <p class="text-muted">Quick list of all published endpoints (public first, then authenticated/admin). For details, see the sections above.</p>
    <ul>
        <li>Public widgets/APIs: <code>/api/now</code>, <code>/api/now/widget</code>, <code>/api/now/recent-tracks</code>, <code>/api/stream/status</code>, <code>/api/schedule</code>, <code>/schedule/grid</code>, <code>/schedule/ical</code>, <code>/api/plugins/website/content</code>, <code>/api/djs</code>, <code>/api/weather/tempest</code>, <code>/api/psa/library</code>, <code>/dj/status</code>, <code>/logs/submit</code>.</li>
        <li>Logging & reports: <code>/logs/view</code>, <code>/logs/download/csv</code>, <code>/logs/download/docx</code>, <code>/api/reports/artist-frequency</code>, <code>/api/psa/compliance/&lt;run_id&gt;</code>.</li>
        <li>Probes, runs, audits: <code>/api/probe</code>, <code>/api/probes/latest</code>, <code>/api/runs/&lt;id&gt;</code>, <code>/api/runs/&lt;id&gt;/logs</code>, <code>/api/audit/start</code>, <code>/api/audit/status/&lt;job_id&gt;</code>.</li>
        <li>Music library: <code>/api/music/search</code>, <code>/api/music/detail</code>, <code>/api/music/cover-image</code>, <code>/api/music/cover-art</code>, <code>/api/music/musicbrainz</code>, <code>/api/music/bulk-update</code>, <code>/api/music/scan/library</code>, <code>/api/music/cue</code>, <code>/api/music/saved-searches</code>, <code>/api/archivist/album-rip</code>, <code>/api/archivist/album-info</code>, archivist CSV import UI, <code>/music/</code> pages for search/detail/edit/cue.</li>
        <li>RadioDJ & stream: <code>/api/radiodj/psas</code>, <code>/api/radiodj/psas/&lt;id&gt;/enable</code>, <code>/api/radiodj/psas/&lt;id&gt;/disable</code>, <code>/api/radiodj/psas/&lt;id&gt;</code> (DELETE), <code>/api/radiodj/psas/&lt;id&gt;/metadata</code>, <code>/api/radiodj/import/news</code>, <code>/api/radiodj/import/community_calendar</code>, <code>/api/icecast/analytics</code>.</li>
        <li>Absences & DJs: <code>/dj/absence</code> (public form), <code>/absences</code> (manage/filter), <code>/djs</code> (list), <code>/djs/&lt;id&gt;</code> (profile), <code>/djs/add</code>, <code>/djs/&lt;id&gt;/edit</code>, <code>/djs/discipline</code>.</li>
        <li>Plugins & content: <code>/plugins</code> (admin list), <code>/plugins/website</code> (content/podcasts), <code>/plugins/automation-bridge</code>, <code>/plugins/remote-link</code>, <code>/api/plugins/website/content</code>.</li>
        <li>News & uploads: <code>/news/upload</code>, <code>/api/radiodj/import/news</code>, <code>/api/radiodj/import/community_calendar</code>.</li>
        <li>Social posting: <code>/social/post</code>, <code>/api/oauth/x-token</code> (last X token), Twitter OAuth helper actions in Social settings.</li>
        <li>Settings/Auth: <code>/settings</code>, <code>/settings/export</code>, <code>/settings/import</code>, <code>/settings/backup-now</code>, <code>/settings/backup-data</code>, <code>/login</code>, <code>/login/master</code>, <code>/logout</code>, <code>/api/oauth/last-token</code>, <code>/api/oauth/x-token</code>.</li>
    </ul>

    <hr>
    <h5>Example: Now Playing (on-air)</h5>
    <pre><code>{
  "status": "on_air",
  "show": {"name": "Morning Buzz", "host": "Alex Smith", "genre": "Talk", "description": "Campus headlines", "regular_host": true, "window": {"start_time": "08:00","end_time": "10:00","start_date": "2025-01-01","end_date": "2025-12-31","days_of_week": "mon"}},
  "run": {"id": 42, "show_name": "Morning Buzz", "dj": "Alex Smith", "start_time": "2025-12-22T13:00:00", "end_time": null, "classification": "live_show", "classification_reason": "dynamic_levels", "avg_db": -12.3, "silence_ratio": 0.02, "automation_ratio": 0.1, "flagged_missed": false}
}</code></pre>

    <h5>Example: Music Search</h5>
    <pre><code>GET /api/music/search?q=dua
[
  {"title": "Houdini", "artist": "Dua Lipa", "album": "Radical Optimism", "path": "/nas/music/Dua Lipa/Houdini.mp3", ...}
]</code></pre>

    <h5>Example: DJs</h5>
    <pre><code>GET /api/djs
[
  {
    "id": 5,
    "first_name": "Chris",
    "last_name": "Rivera",
    "bio": "Loves vinyl and campus news.",
    "photo_url": "https://example.com/djs/chris.jpg",
    "shows": [
      {"id": 7, "name": "Evening Drive", "start_time": "17:00", "end_time": "19:00", "days_of_week": "mon", "genre": "Rock", "description": "Alt/indie drive-time"}
    ]
  }
]</code></pre>
</div>
{% include '_footer.html' %}
</body>
</html>
