<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CUE Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .wave-container {height:120px; background:rgba(0,0,0,0.05); border-radius:6px; padding:10px; position:relative; overflow:hidden;}
        .wave-bar {width:3px; background:#0d6efd; display:inline-block; margin-right:1px; vertical-align:bottom;}
        .marker {position:absolute; top:0; bottom:0; width:2px; background:orange;}
        .marker-label {font-size:11px; background:rgba(0,0,0,0.65); color:#fff; padding:2px 4px; border-radius:4px; white-space:nowrap;}
        #markers {position:absolute; inset:0; pointer-events:none;}
    </style>
</head>
<body>
{% include '_nav.html' %}
<div class="container mt-4">
    <h3>CUE Editor</h3>
    {% if track %}
    <p class="text-muted">{{ track.title }} â€” {{ track.artist }}</p>
    <div class="mb-3">
        <audio id="player" controls preload="metadata" style="width:100%;" src="/music/stream?path={{ track.path|urlencode }}"></audio>
        <div class="mt-2 position-relative wave-container" id="wave">
            {% if track.peaks %}
                {% set total = track.peaks|length %}
                {% for p in track.peaks %}
                    <div class="wave-bar" style="height:{{ (p*100)|round(0,'floor') }}px"></div>
                {% endfor %}
            {% else %}
                <div class="text-muted">Waveform preview unavailable.</div>
            {% endif %}
            <div id="needle" class="marker" style="left:0"></div>
            <div id="markers"></div>
        </div>
    </div>
    <form method="post" class="row g-3" id="cue-form">
        {% set fields = {
            'cue_in':'Cue In',
            'intro':'Intro',
            'hook_in':'Hook In',
            'hook_out':'Hook Out',
            'start_next':'Start Next',
            'outro':'Outro',
            'cue_out':'End/Cue Out',
            'fade_in':'Fade In',
            'fade_out':'Fade Out'
        } %}
        {% for key,label in fields.items() %}
        <div class="col-md-4">
            <label class="form-label d-flex justify-content-between align-items-center">
                <span>{{ label }} (s)</span>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCue('{{ key }}')">Set</button>
            </label>
            <input type="number" step="0.01" name="{{ key }}" id="{{ key }}" value="{{ cue[key] if cue else '' }}" class="form-control" onchange="updateMarkers()">
        </div>
        {% endfor %}
        <div class="col-12">
            <button class="btn btn-primary" type="submit">Save CUE</button>
            <a class="btn btn-secondary" href="/music/detail?path={{ track.path|urlencode }}">Back</a>
        </div>
    </form>
    {% else %}
    <p>Track not found.</p>
    {% endif %}
</div>
{% include '_footer.html' %}
<script>
    const player = document.getElementById('player');
    const needle = document.getElementById('needle');
    const wave = document.getElementById('wave');
    const markersLayer = document.getElementById('markers');

    function setCue(field) {
        if (!player || isNaN(player.currentTime)) return;
        const input = document.getElementById(field);
        input.value = player.currentTime.toFixed(2);
        updateMarkers();
    }

    function updateNeedle() {
        if (!player || !player.duration || !needle) return;
        const pct = (player.currentTime / player.duration) * 100;
        needle.style.left = pct + '%';
    }

    function updateMarkers() {
        if (!player || !player.duration || !markersLayer) return;
        markersLayer.innerHTML = '';
        const fields = ['cue_in','intro','hook_in','hook_out','start_next','outro','cue_out'];
        fields.forEach(f => {
            const val = parseFloat(document.getElementById(f)?.value || '');
            if (!isNaN(val) && val >= 0 && val <= player.duration) {
                const pct = (val / player.duration) * 100;
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.left = pct + '%';
                const label = document.createElement('div');
                label.className = 'marker-label position-absolute';
                label.style.left = pct + '%';
                label.style.transform = 'translateX(-50%) translateY(-100%)';
                label.textContent = f.replace('_', ' ');
                markersLayer.appendChild(marker);
                markersLayer.appendChild(label);
            }
        });
    }

    if (player) {
        player.addEventListener('timeupdate', updateNeedle);
        player.addEventListener('loadedmetadata', () => {
            updateNeedle();
            updateMarkers();
        });
    }
    updateMarkers();
</script>
</body>
</html>
