<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Library Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .list-group-item-action.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .library-pane {
            max-height: 68vh;
            overflow: auto;
        }
        .library-controls {
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .grid-card {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            height: 100%;
        }
        .grid-card.active {
            border-color: #0d6efd;
            box-shadow: 0 0 0 2px rgba(13,110,253,0.2);
        }
        .sort-header {
            cursor: pointer;
        }
        .sort-header .sort-indicator {
            font-size: 0.7rem;
            margin-left: 0.25rem;
        }
        .cover-preview {
            width: 96px;
            height: 96px;
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
            object-fit: cover;
            background-color: #f8f9fa;
        }
        .cue-link-card {
            border: 1px dashed rgba(13,110,253,0.4);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .cue-link-card:hover {
            background-color: rgba(13,110,253,0.05);
            border-color: rgba(13,110,253,0.65);
        }
        #cueEditorLink.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
</head>
<body>
{% include '_nav.html' %}
<div class="container-fluid px-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Library Editor</h2>
            <div class="text-muted small">Browse artists, albums, songs, PSAs, and imaging with inline metadata edits.</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-secondary">Index snapshot loaded</span>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header">
                    <ul class="nav nav-pills card-header-pills" id="libraryTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-mode="music" type="button">Music</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-mode="psa" type="button">PSA / Imaging</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="library-controls border-bottom p-3" id="musicControls">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="fw-semibold small text-uppercase text-muted">Browse</div>
                            <div class="btn-group btn-group-sm" id="browseModeToggle" role="group" aria-label="Browse mode">
                                <button class="btn btn-outline-secondary active" data-browse="artist" type="button">Artist</button>
                                <button class="btn btn-outline-secondary" data-browse="genre" type="button">Genre</button>
                            </div>
                        </div>
                        <input class="form-control form-control-sm" id="librarySearch" type="search" placeholder="Search artist, album, title, or genre">
                    </div>
                    <div class="library-pane p-3">
                        <div id="musicBrowser">
                            <div id="artistBrowser">
                                <div class="mb-3">
                                    <div class="fw-semibold small text-uppercase text-muted">Artists</div>
                                    <div class="list-group list-group-flush" id="artistList"></div>
                                </div>
                                <div>
                                    <div class="fw-semibold small text-uppercase text-muted">Albums</div>
                                    <div class="list-group list-group-flush" id="albumList"></div>
                                </div>
                            </div>
                            <div id="genreBrowser" class="d-none">
                                <div class="mb-3">
                                    <div class="fw-semibold small text-uppercase text-muted">Genres</div>
                                    <div class="list-group list-group-flush" id="genreList"></div>
                                </div>
                                <div>
                                    <div class="fw-semibold small text-uppercase text-muted">Artists</div>
                                    <div class="list-group list-group-flush" id="genreArtistList"></div>
                                </div>
                            </div>
                        </div>
                        <div id="psaBrowser" class="d-none">
                            <div class="mb-3">
                                <div class="fw-semibold small text-uppercase text-muted">Collections</div>
                                <div class="list-group list-group-flush" id="psaCategoryList"></div>
                            </div>
                            <div>
                                <div class="fw-semibold small text-uppercase text-muted">Items</div>
                                <div class="list-group list-group-flush" id="psaItemList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Library Items</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary active" id="listToggle" type="button">List</button>
                        <button class="btn btn-outline-secondary" id="gridToggle" type="button">Grid</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small" id="selectionSummary">Select an artist, album, or PSA collection.</div>
                        <div class="text-muted small">Sort by: <span id="sortLabel">Artist</span></div>
                    </div>
                    <div class="btn-group btn-group-sm mb-2" id="trackFilter" role="group" aria-label="Track filters">
                        <button class="btn btn-outline-secondary active" data-filter="all" type="button">All</button>
                        <button class="btn btn-outline-secondary" data-filter="recent" type="button">Recent</button>
                        <button class="btn btn-outline-secondary" data-filter="missing_cues" type="button">Missing Cues</button>
                    </div>
                    <div class="table-responsive" id="listView">
                        <table class="table table-sm table-hover align-middle">
                            <thead>
                                <tr>
                                    <th class="sort-header" data-sort="artist">Artist<span class="sort-indicator" id="sort-artist"></span></th>
                                    <th class="sort-header" data-sort="album">Album<span class="sort-indicator" id="sort-album"></span></th>
                                    <th>Title</th>
                                    <th class="sort-header" data-sort="year">Year<span class="sort-indicator" id="sort-year"></span></th>
                                    <th class="sort-header" data-sort="genre">Genre<span class="sort-indicator" id="sort-genre"></span></th>
                                </tr>
                            </thead>
                            <tbody id="trackTableBody"></tbody>
                        </table>
                    </div>
                    <div class="row g-2 d-none" id="gridView"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">Metadata Editor</div>
                <div class="card-body">
                    <form id="metadataForm">
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <img class="cover-preview" id="previewCover" alt="Album cover preview">
                                <div class="flex-grow-1">
                                    <div class="small text-muted text-uppercase">Preview Player</div>
                                    <div class="fw-semibold" id="previewTitle">Select a track to preview.</div>
                                    <div class="text-muted small" id="previewSubtitle">Album art and audio preview will appear here.</div>
                                    <audio class="w-100 mt-2" id="previewPlayer" controls preload="none"></audio>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Artist</label>
                            <input type="text" class="form-control" id="metaArtist" placeholder="Artist name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Album</label>
                            <input type="text" class="form-control" id="metaAlbum" placeholder="Album name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="metaTitle" placeholder="Song or spot title">
                        </div>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <label class="form-label">Year</label>
                                <input type="text" class="form-control" id="metaYear" placeholder="YYYY">
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label">Genre</label>
                                <input type="text" class="form-control" id="metaGenre" placeholder="Genre">
                            </div>
                        </div>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="metaExplicit">
                            <label class="form-check-label" for="metaExplicit">Explicit</label>
                        </div>
                        <hr>
                        <a class="text-decoration-none" id="cueEditorLink" href="#" target="_blank" rel="noopener">
                            <div class="cue-link-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">Cues</div>
                                        <div class="text-muted small">Open the cue editor for this track.</div>
                                    </div>
                                    <span class="text-primary fw-semibold">Edit →</span>
                                </div>
                            </div>
                        </a>
                        <div class="mt-3">
                            <label class="form-label small text-muted">File Path</label>
                            <input type="text" class="form-control form-control-sm" id="metaPath" readonly>
                        </div>
                        <div class="text-muted small mt-2" id="saveStatus"></div>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="resetMetadata">Reset</button>
                            <button class="btn btn-primary btn-sm" type="button" id="saveMetadata" disabled>Save</button>
                        </div>
                    </form>
                    <div class="text-muted small mt-2">Edits are staged here and will connect to PSA/Imaging metadata work.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const libraryData = {{ library_index | tojson }};
    const normalizeText = (value) => (value ?? '').toString().toLowerCase();
    const state = {
        mode: 'music',
        artists: libraryData.music || [],
        genres: libraryData.genres || [],
        psa: libraryData.psa_imaging || [],
        musicBrowseMode: 'artist',
        searchTerm: '',
        artistIndex: new Map(),
        genreIndex: new Map(),
        artistSearch: new Map(),
        albumSearch: new Map(),
        genreSearch: new Map(),
        genreArtistSearch: new Map(),
        selectedArtist: null,
        selectedAlbum: null,
        selectedGenre: null,
        selectedGenreArtist: null,
        selectedCategory: null,
        selectedItem: null,
        tracks: [],
        trackFilter: 'all',
        view: 'list',
        sortKey: 'artist',
        sortDir: 'asc'
    };

    const artistList = document.getElementById('artistList');
    const albumList = document.getElementById('albumList');
    const genreList = document.getElementById('genreList');
    const genreArtistList = document.getElementById('genreArtistList');
    const psaCategoryList = document.getElementById('psaCategoryList');
    const psaItemList = document.getElementById('psaItemList');
    const trackTableBody = document.getElementById('trackTableBody');
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');
    const selectionSummary = document.getElementById('selectionSummary');
    const sortLabel = document.getElementById('sortLabel');
    const librarySearch = document.getElementById('librarySearch');
    const trackFilterGroup = document.getElementById('trackFilter');
    const musicControls = document.getElementById('musicControls');

    const formFields = {
        artist: document.getElementById('metaArtist'),
        album: document.getElementById('metaAlbum'),
        title: document.getElementById('metaTitle'),
        year: document.getElementById('metaYear'),
        genre: document.getElementById('metaGenre'),
        explicit: document.getElementById('metaExplicit'),
        path: document.getElementById('metaPath')
    };
    const previewCover = document.getElementById('previewCover');
    const previewPlayer = document.getElementById('previewPlayer');
    const previewTitle = document.getElementById('previewTitle');
    const previewSubtitle = document.getElementById('previewSubtitle');
    const cueEditorLink = document.getElementById('cueEditorLink');
    const saveMetadataBtn = document.getElementById('saveMetadata');
    const saveStatus = document.getElementById('saveStatus');
    const placeholderCover = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%25" height="100%25" fill="%23f8f9fa"/><text x="50%25" y="50%25" font-family="Arial" font-size="20" fill="%2399a0a7" dominant-baseline="middle" text-anchor="middle">No Cover</text></svg>';
    const formState = {
        baseline: null,
        saving: false
    };
    previewCover.src = placeholderCover;
    cueEditorLink.classList.add('disabled');

    const debounce = (callback, wait = 200) => {
        let timeout;
        return (...args) => {
            window.clearTimeout(timeout);
            timeout = window.setTimeout(() => callback(...args), wait);
        };
    };

    const buildArtistCache = () => {
        const artistIndex = new Map();
        const artistSearch = new Map();
        const albumSearch = new Map();
        state.artists.forEach(artist => {
            const albumSearchMap = new Map();
            const artistParts = [artist.name];
            (artist.albums || []).forEach(album => {
                const albumParts = [album.name, album.genre, album.year];
                (album.tracks || []).forEach(track => {
                    albumParts.push(track.title, track.genre, track.artist, track.album);
                });
                const albumBlob = normalizeText(albumParts.join(' '));
                albumSearchMap.set(album.name, albumBlob);
                artistParts.push(albumBlob);
            });
            artistIndex.set(artist.name, { ...artist, albumSearchMap });
            artistSearch.set(artist.name, normalizeText(artistParts.join(' ')));
            albumSearch.set(artist.name, albumSearchMap);
        });
        state.artistIndex = artistIndex;
        state.artistSearch = artistSearch;
        state.albumSearch = albumSearch;
    };

    const buildGenreCache = () => {
        const genreIndex = new Map();
        const genreSearch = new Map();
        const genreArtistSearch = new Map();
        state.genres.forEach(genre => {
            const artistSearchMap = new Map();
            const genreParts = [genre.name];
            (genre.tracks || []).forEach(track => {
                const artistName = track.artist || 'Unknown Artist';
                const artistBlob = artistSearchMap.get(artistName) || '';
                const nextBlob = `${artistBlob} ${track.title || ''} ${track.album || ''} ${track.genre || ''}`.trim();
                artistSearchMap.set(artistName, normalizeText(nextBlob));
                genreParts.push(track.artist, track.album, track.title, track.genre);
            });
            genreIndex.set(genre.name, genre);
            genreSearch.set(genre.name, normalizeText(genreParts.join(' ')));
            genreArtistSearch.set(genre.name, artistSearchMap);
        });
        state.genreIndex = genreIndex;
        state.genreSearch = genreSearch;
        state.genreArtistSearch = genreArtistSearch;
    };

    const buildCaches = () => {
        buildArtistCache();
        buildGenreCache();
    };

    const setActiveListItem = (container, activeValue) => {
        container.querySelectorAll('.list-group-item').forEach(item => {
            item.classList.toggle('active', item.dataset.value === activeValue);
        });
    };

    const updateMetadataForm = (item) => {
        formFields.artist.value = item?.artist || '';
        formFields.album.value = item?.album || '';
        formFields.title.value = item?.title || '';
        formFields.year.value = item?.year || '';
        formFields.genre.value = item?.genre || '';
        formFields.explicit.checked = Boolean(item?.explicit);
        formFields.path.value = item?.path || '';
        const title = item?.title || 'Select a track to preview.';
        const artist = item?.artist || '';
        const album = item?.album || '';
        previewTitle.textContent = title;
        previewSubtitle.textContent = [artist, album].filter(Boolean).join(' · ') || 'Album art and audio preview will appear here.';
        const path = item?.path || '';
        previewPlayer.src = path ? `/music/stream?path=${encodeURIComponent(path)}` : '';
        previewCover.src = path ? `/music/cover?path=${encodeURIComponent(path)}` : placeholderCover;
        previewCover.onerror = () => {
            previewCover.src = placeholderCover;
        };
        cueEditorLink.href = path ? `/music/cue?path=${encodeURIComponent(path)}` : '#';
        cueEditorLink.classList.toggle('disabled', !path);
        cueEditorLink.setAttribute('aria-disabled', path ? 'false' : 'true');
        saveStatus.textContent = '';
        formState.baseline = getFormState();
        updateSaveState();
    };

    const getFormState = () => ({
        artist: formFields.artist.value.trim(),
        album: formFields.album.value.trim(),
        title: formFields.title.value.trim(),
        year: formFields.year.value.trim(),
        genre: formFields.genre.value.trim(),
        explicit: formFields.explicit.checked,
        path: formFields.path.value
    });

    const hasFormChanges = () => {
        if (!formState.baseline) {
            return false;
        }
        const current = getFormState();
        return Object.keys(current).some(key => current[key] !== formState.baseline[key]);
    };

    const updateSaveState = () => {
        const allowSave = state.selectedItem && hasFormChanges() && !formState.saving;
        saveMetadataBtn.disabled = !allowSave;
    };

    const sortTracks = (tracks) => {
        const key = state.sortKey;
        const dir = state.sortDir === 'asc' ? 1 : -1;
        tracks.sort((a, b) => {
            const aVal = (a[key] ?? '').toString().toLowerCase();
            const bVal = (b[key] ?? '').toString().toLowerCase();
            if (key === 'year') {
                return dir * ((parseInt(aVal || '0', 10)) - (parseInt(bVal || '0', 10)));
            }
            if (aVal < bVal) return -1 * dir;
            if (aVal > bVal) return 1 * dir;
            return 0;
        });
    };

    const applyTrackFilters = (tracks) => {
        if (state.mode !== 'music' || state.trackFilter === 'all') {
            return tracks;
        }
        if (state.trackFilter === 'recent') {
            return tracks.filter(track => track.is_recent);
        }
        if (state.trackFilter === 'missing_cues') {
            return tracks.filter(track => track.missing_cues);
        }
        return tracks;
    };

    const renderTracks = () => {
        const baseTracks = state.tracks;
        const filteredTracks = applyTrackFilters(baseTracks);
        const sortedTracks = [...filteredTracks];
        sortTracks(sortedTracks);
        trackTableBody.innerHTML = '';
        gridView.innerHTML = '';
        if (!baseTracks.length) {
            trackTableBody.innerHTML = '<tr><td colspan="5" class="text-muted">No items selected.</td></tr>';
            if (state.mode === 'psa') {
                selectionSummary.textContent = 'Select a PSA collection.';
            } else if (state.musicBrowseMode === 'genre') {
                selectionSummary.textContent = 'Select a genre to view tracks.';
            } else {
                selectionSummary.textContent = 'Select an artist or album.';
            }
            return;
        }
        if (!filteredTracks.length) {
            trackTableBody.innerHTML = '<tr><td colspan="5" class="text-muted">No items match the current filter.</td></tr>';
            selectionSummary.textContent = `0 of ${baseTracks.length} items shown`;
            return;
        }
        selectionSummary.textContent = filteredTracks.length === baseTracks.length
            ? `${filteredTracks.length} items shown`
            : `${filteredTracks.length} of ${baseTracks.length} items shown`;
        sortedTracks.forEach((track, idx) => {
            const row = document.createElement('tr');
            row.className = track.path === state.selectedItem?.path ? 'table-primary' : '';
            row.innerHTML = `
                <td>${track.artist || '-'}</td>
                <td>${track.album || '-'}</td>
                <td>${track.title || '-'}</td>
                <td>${track.year || '-'}</td>
                <td>${track.genre || '-'}</td>
            `;
            row.addEventListener('click', () => {
                state.selectedItem = track;
                updateMetadataForm(track);
                renderTracks();
            });
            trackTableBody.appendChild(row);

            const col = document.createElement('div');
            col.className = 'col-12';
            if (state.view === 'grid') {
                col.className = 'col-md-6';
            }
            const card = document.createElement('div');
            card.className = `grid-card ${track.path === state.selectedItem?.path ? 'active' : ''}`;
            card.innerHTML = `
                <div class="fw-semibold">${track.title || '-'}</div>
                <div class="text-muted small">${track.artist || 'Unknown Artist'} · ${track.album || 'Unknown Album'}</div>
                <div class="small mt-1">Year: ${track.year || '—'} · Genre: ${track.genre || '—'}</div>
            `;
            card.addEventListener('click', () => {
                state.selectedItem = track;
                updateMetadataForm(track);
                renderTracks();
            });
            col.appendChild(card);
            gridView.appendChild(col);
        });
    };

    const matchesSearch = (blob) => {
        if (!state.searchTerm) {
            return true;
        }
        return (blob || '').includes(state.searchTerm);
    };

    const getFilteredArtists = () => state.artists.filter(artist => {
        const blob = state.artistSearch.get(artist.name) || '';
        return matchesSearch(blob);
    });

    const getFilteredGenres = () => state.genres.filter(genre => {
        const blob = state.genreSearch.get(genre.name) || '';
        return matchesSearch(blob);
    });

    const renderArtists = () => {
        artistList.innerHTML = '';
        const filteredArtists = getFilteredArtists();
        if (!filteredArtists.length) {
            artistList.innerHTML = '<div class="text-muted small">No artists match the current search.</div>';
        }
        if (state.selectedArtist && !filteredArtists.find(artist => artist.name === state.selectedArtist)) {
            state.selectedArtist = null;
            state.selectedAlbum = null;
            state.tracks = [];
            renderTracks();
        }
        filteredArtists.forEach(artist => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = artist.name;
            btn.textContent = artist.name;
            btn.addEventListener('click', () => {
                state.selectedArtist = artist.name;
                state.selectedAlbum = null;
                setActiveListItem(artistList, artist.name);
                renderAlbums();
                state.tracks = artist.albums.flatMap(album => album.tracks);
                renderTracks();
            });
            artistList.appendChild(btn);
        });
    };

    const renderAlbums = () => {
        albumList.innerHTML = '';
        const artist = state.artists.find(a => a.name === state.selectedArtist);
        if (!artist) {
            albumList.innerHTML = '<div class="text-muted small">Select an artist to view albums.</div>';
            return;
        }
        const albumSearchMap = state.albumSearch.get(artist.name) || new Map();
        const filteredAlbums = (artist.albums || []).filter(album => {
            if (!state.searchTerm) {
                return true;
            }
            return matchesSearch(albumSearchMap.get(album.name) || '');
        });
        if (!filteredAlbums.length) {
            albumList.innerHTML = '<div class="text-muted small">No albums match the current search.</div>';
            return;
        }
        filteredAlbums.forEach(album => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = album.name;
            btn.innerHTML = `<div class="fw-semibold">${album.name}</div><div class="small text-muted">${album.year || 'Year n/a'} · ${album.genre || 'Genre n/a'}</div>`;
            btn.addEventListener('click', () => {
                state.selectedAlbum = album.name;
                setActiveListItem(albumList, album.name);
                state.tracks = album.tracks;
                renderTracks();
            });
            albumList.appendChild(btn);
        });
    };

    const renderGenres = () => {
        genreList.innerHTML = '';
        const filteredGenres = getFilteredGenres();
        if (!filteredGenres.length) {
            genreList.innerHTML = '<div class="text-muted small">No genres match the current search.</div>';
        }
        if (state.selectedGenre && !filteredGenres.find(genre => genre.name === state.selectedGenre)) {
            state.selectedGenre = null;
            state.selectedGenreArtist = null;
            state.tracks = [];
            renderTracks();
        }
        filteredGenres.forEach(genre => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = genre.name;
            btn.textContent = genre.name;
            btn.addEventListener('click', () => {
                state.selectedGenre = genre.name;
                state.selectedGenreArtist = null;
                setActiveListItem(genreList, genre.name);
                renderGenreArtists();
                state.tracks = genre.tracks || [];
                renderTracks();
            });
            genreList.appendChild(btn);
        });
    };

    const renderGenreArtists = () => {
        genreArtistList.innerHTML = '';
        const genre = state.genres.find(g => g.name === state.selectedGenre);
        if (!genre) {
            genreArtistList.innerHTML = '<div class="text-muted small">Select a genre to view artists.</div>';
            return;
        }
        const artistSearchMap = state.genreArtistSearch.get(genre.name) || new Map();
        const artists = (genre.artists || []).filter(name => {
            if (!state.searchTerm) {
                return true;
            }
            return matchesSearch(artistSearchMap.get(name) || '');
        });
        if (!artists.length) {
            genreArtistList.innerHTML = '<div class="text-muted small">No artists match the current search.</div>';
            return;
        }
        if (state.selectedGenreArtist && !artists.includes(state.selectedGenreArtist)) {
            state.selectedGenreArtist = null;
            state.tracks = genre.tracks || [];
            renderTracks();
        }
        artists.forEach(name => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = name;
            btn.textContent = name;
            btn.addEventListener('click', () => {
                state.selectedGenreArtist = name;
                setActiveListItem(genreArtistList, name);
                state.tracks = (genre.tracks || []).filter(track => track.artist === name);
                renderTracks();
            });
            genreArtistList.appendChild(btn);
        });
    };

    const renderPsaCategories = () => {
        psaCategoryList.innerHTML = '';
        state.psa.forEach(category => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = category.category;
            btn.textContent = category.category;
            btn.addEventListener('click', () => {
                state.selectedCategory = category.category;
                setActiveListItem(psaCategoryList, category.category);
                renderPsaItems();
            });
            psaCategoryList.appendChild(btn);
        });
    };

    const renderPsaItems = () => {
        psaItemList.innerHTML = '';
        const category = state.psa.find(c => c.category === state.selectedCategory);
        if (!category) {
            psaItemList.innerHTML = '<div class="text-muted small">Select a collection to see items.</div>';
            state.tracks = [];
            renderTracks();
            return;
        }
        category.items.forEach(item => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.value = item.path;
            btn.textContent = item.title;
            btn.addEventListener('click', () => {
                state.selectedItem = item;
                updateMetadataForm(item);
                setActiveListItem(psaItemList, item.path);
            });
            psaItemList.appendChild(btn);
        });
        state.tracks = category.items.map(item => ({
            ...item,
            artist: item.artist || category.category,
            album: item.album || item.folder || category.category
        }));
        renderTracks();
    };

    const renderMusicLists = () => {
        document.getElementById('artistBrowser').classList.toggle('d-none', state.musicBrowseMode !== 'artist');
        document.getElementById('genreBrowser').classList.toggle('d-none', state.musicBrowseMode !== 'genre');
        if (state.musicBrowseMode === 'artist') {
            renderArtists();
            renderAlbums();
        } else {
            renderGenres();
            renderGenreArtists();
        }
    };

    const setBrowseMode = (browseMode) => {
        state.musicBrowseMode = browseMode;
        state.selectedArtist = null;
        state.selectedAlbum = null;
        state.selectedGenre = null;
        state.selectedGenreArtist = null;
        state.tracks = [];
        renderMusicLists();
        renderTracks();
    };

    const setMode = (mode) => {
        state.mode = mode;
        musicControls.classList.toggle('d-none', mode !== 'music');
        document.getElementById('musicBrowser').classList.toggle('d-none', mode !== 'music');
        document.getElementById('psaBrowser').classList.toggle('d-none', mode !== 'psa');
        trackFilterGroup.classList.toggle('d-none', mode !== 'music');
        if (mode === 'music') {
            state.selectedCategory = null;
            state.tracks = [];
            renderMusicLists();
            renderTracks();
        } else {
            state.selectedArtist = null;
            state.selectedAlbum = null;
            state.selectedGenre = null;
            state.selectedGenreArtist = null;
            state.tracks = [];
            renderPsaCategories();
            renderPsaItems();
        }
    };

    document.querySelectorAll('#libraryTabs .nav-link').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('#libraryTabs .nav-link').forEach(btn => btn.classList.remove('active'));
            tab.classList.add('active');
            setMode(tab.dataset.mode);
        });
    });

    document.querySelectorAll('#browseModeToggle .btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#browseModeToggle .btn').forEach(toggle => toggle.classList.remove('active'));
            btn.classList.add('active');
            setBrowseMode(btn.dataset.browse);
        });
    });

    librarySearch.addEventListener('input', debounce(() => {
        state.searchTerm = normalizeText(librarySearch.value);
        renderMusicLists();
    }, 250));

    document.getElementById('listToggle').addEventListener('click', () => {
        state.view = 'list';
        listView.classList.remove('d-none');
        gridView.classList.add('d-none');
        document.getElementById('listToggle').classList.add('active');
        document.getElementById('gridToggle').classList.remove('active');
    });

    document.getElementById('gridToggle').addEventListener('click', () => {
        state.view = 'grid';
        listView.classList.add('d-none');
        gridView.classList.remove('d-none');
        document.getElementById('gridToggle').classList.add('active');
        document.getElementById('listToggle').classList.remove('active');
        renderTracks();
    });

    document.querySelectorAll('#trackFilter .btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#trackFilter .btn').forEach(filterBtn => filterBtn.classList.remove('active'));
            btn.classList.add('active');
            state.trackFilter = btn.dataset.filter || 'all';
            renderTracks();
        });
    });

    document.querySelectorAll('.sort-header').forEach(header => {
        header.addEventListener('click', () => {
            const key = header.dataset.sort;
            if (!key) return;
            if (state.sortKey === key) {
                state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortKey = key;
                state.sortDir = 'asc';
            }
            sortLabel.textContent = key.charAt(0).toUpperCase() + key.slice(1);
            document.querySelectorAll('.sort-indicator').forEach(indicator => indicator.textContent = '');
            const indicator = document.getElementById(`sort-${key}`);
            indicator.textContent = state.sortDir === 'asc' ? '▲' : '▼';
            renderTracks();
        });
    });

    document.getElementById('resetMetadata').addEventListener('click', () => {
        updateMetadataForm(state.selectedItem);
    });

    Object.values(formFields).forEach(field => {
        if (!field) return;
        const eventName = field.type === 'checkbox' ? 'change' : 'input';
        field.addEventListener(eventName, () => {
            updateSaveState();
        });
    });

    saveMetadataBtn.addEventListener('click', async () => {
        if (!state.selectedItem) return;
        const current = getFormState();
        const baseline = formState.baseline || {};
        if (!current.path) return;
        const updates = {};
        ['artist', 'album', 'title', 'year', 'genre', 'explicit'].forEach(key => {
            if (current[key] !== baseline[key]) {
                updates[key] = current[key];
            }
        });
        if (!Object.keys(updates).length) {
            updateSaveState();
            return;
        }
        formState.saving = true;
        updateSaveState();
        saveStatus.textContent = 'Saving changes...';
        saveStatus.classList.remove('text-danger');
        try {
            const res = await fetch('/api/music/bulk-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paths: [current.path], updates })
            });
            const payload = await res.json();
            if (!res.ok || payload.status !== 'ok') {
                throw new Error(payload.message || 'Unable to save changes.');
            }
            Object.assign(state.selectedItem, updates);
            formState.baseline = getFormState();
            saveStatus.textContent = 'Saved successfully.';
            saveStatus.classList.remove('text-danger');
            renderTracks();
        } catch (error) {
            saveStatus.textContent = error?.message || 'Unable to save changes.';
            saveStatus.classList.add('text-danger');
        } finally {
            formState.saving = false;
            updateSaveState();
            setTimeout(() => {
                saveStatus.classList.remove('text-danger');
            }, 2000);
        }
    });

    buildCaches();
    renderMusicLists();
    renderTracks();
</script>
</body>
</html>
