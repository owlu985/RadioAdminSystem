<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Show Automator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
{% include '_nav.html' %}
<div class="container mt-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h3 class="mb-0">Show Automator</h3>
            <div class="text-muted">DJ Tools &middot; Manual controls ready for on-air use.</div>
        </div>
        <span class="badge bg-success">Manual Control Active</span>
    </div>

    <div class="alert alert-info">
        Automation hooks are coming soon. All controls below remain available for manual operation today.
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Now Playing</span>
                    <span class="text-muted small">Deck A</span>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-4 text-center">
                            <img src="https://via.placeholder.com/240x240.png?text=Album+Art" alt="Album art" class="img-fluid rounded shadow-sm">
                            <div class="mt-2 small text-muted">Live audio bed available</div>
                        </div>
                        <div class="col-md-8">
                            <h4 class="mb-1">Midnight Drive</h4>
                            <div class="text-muted">Artist: The Night Shift</div>
                            <div class="text-muted">Album: City Lights &middot; 2023</div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between">
                                    <span class="small text-muted">Playback Position</span>
                                    <span class="small">01:42 / 04:10</span>
                                </div>
                                <input type="range" class="form-range" value="42">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Live Queue</h5>
                        <span class="text-muted small">Drag & drop planned</span>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">Station ID &mdash; Summer</div>
                                <div class="small text-muted">Imaging &middot; :10</div>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Queue controls">
                                <button class="btn btn-outline-secondary" type="button">↑</button>
                                <button class="btn btn-outline-secondary" type="button">↓</button>
                                <button class="btn btn-outline-danger" type="button">Remove</button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">Community PSA: Food Drive</div>
                                <div class="small text-muted">PSA &middot; :30</div>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Queue controls">
                                <button class="btn btn-outline-secondary" type="button">↑</button>
                                <button class="btn btn-outline-secondary" type="button">↓</button>
                                <button class="btn btn-outline-danger" type="button">Remove</button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">Next Track: Golden Hour</div>
                                <div class="small text-muted">Music &middot; 03:22</div>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Queue controls">
                                <button class="btn btn-outline-secondary" type="button">↑</button>
                                <button class="btn btn-outline-secondary" type="button">↓</button>
                                <button class="btn btn-outline-danger" type="button">Remove</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Deck Controls</span>
                    <span class="text-muted small">Manual</span>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100 mb-2" role="group" aria-label="Playback controls">
                        <button class="btn btn-primary" type="button">Play</button>
                        <button class="btn btn-outline-primary" type="button">Pause</button>
                        <button class="btn btn-outline-secondary" type="button">Cue In</button>
                        <button class="btn btn-outline-secondary" type="button">Cue Out</button>
                    </div>
                    <div class="btn-group w-100 mb-3" role="group" aria-label="Navigation controls">
                        <button class="btn btn-outline-secondary" type="button">Previous</button>
                        <button class="btn btn-outline-secondary" type="button">Fade</button>
                        <button class="btn btn-outline-secondary" type="button">Next</button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Fade Length (seconds)</label>
                        <input type="range" class="form-range" min="0" max="10" value="3">
                    </div>
                    <div>
                        <label class="form-label small text-muted">Output Level</label>
                        <input type="range" class="form-range" min="0" max="100" value="80">
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Run Show Control</div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" type="button">Start Show</button>
                        <button class="btn btn-outline-primary" type="button">Insert PSA</button>
                        <button class="btn btn-outline-primary" type="button">Insert Imaging</button>
                        <button class="btn btn-outline-danger" type="button">Override Next Item</button>
                    </div>
                    <div class="mt-3 small text-muted">Scheduler integration pending. Manual overrides will update the queue locally.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">Library Navigation</div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="libraryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="music-tab" data-bs-toggle="tab" data-bs-target="#music" type="button" role="tab" aria-controls="music" aria-selected="true">Music</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="psa-tab" data-bs-toggle="tab" data-bs-target="#psa" type="button" role="tab" aria-controls="psa" aria-selected="false">PSAs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="imaging-tab" data-bs-toggle="tab" data-bs-target="#imaging" type="button" role="tab" aria-controls="imaging" aria-selected="false">Imaging</button>
                </li>
            </ul>
            <div class="tab-content pt-3" id="libraryTabsContent">
                <div class="tab-pane fade show active" id="music" role="tabpanel" aria-labelledby="music-tab">
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-lg-5">
                            <label class="form-label small text-muted" for="musicSearch">Search</label>
                            <input class="form-control" id="musicSearch" type="text" placeholder="Search tracks (use % for all)">
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label small text-muted" for="musicFolder">Folder</label>
                            <select class="form-select" id="musicFolder">
                                <option value="">All folders</option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label small text-muted" for="musicPerPage">Per page</label>
                            <select class="form-select" id="musicPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="col-lg-2 d-grid">
                            <button class="btn btn-outline-secondary" id="musicRefresh" type="button">Refresh</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Track</th>
                                    <th>Artist</th>
                                    <th>Album</th>
                                    <th>Length</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="musicTableBody"></tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <small class="text-muted" id="musicMeta">Ready to search the music library.</small>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Music pagination">
                            <button class="btn btn-outline-secondary" id="musicPrev" type="button">Prev</button>
                            <button class="btn btn-outline-secondary" id="musicNext" type="button">Next</button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="psa" role="tabpanel" aria-labelledby="psa-tab">
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-lg-5">
                            <label class="form-label small text-muted" for="psaSearch">Search</label>
                            <input class="form-control" id="psaSearch" type="text" placeholder="Search PSA library">
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label small text-muted" for="psaCategory">Category</label>
                            <select class="form-select" id="psaCategory">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label small text-muted" for="psaPerPage">Per page</label>
                            <select class="form-select" id="psaPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="col-lg-2 d-grid">
                            <button class="btn btn-outline-secondary" id="psaRefresh" type="button">Refresh</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>PSA</th>
                                    <th>Category</th>
                                    <th>Length</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="psaTableBody"></tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <small class="text-muted" id="psaMeta">Loading PSA library.</small>
                        <div class="btn-group btn-group-sm" role="group" aria-label="PSA pagination">
                            <button class="btn btn-outline-secondary" id="psaPrev" type="button">Prev</button>
                            <button class="btn btn-outline-secondary" id="psaNext" type="button">Next</button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="imaging" role="tabpanel" aria-labelledby="imaging-tab">
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-lg-5">
                            <label class="form-label small text-muted" for="imagingSearch">Search</label>
                            <input class="form-control" id="imagingSearch" type="text" placeholder="Search imaging library">
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label small text-muted" for="imagingCategory">Category</label>
                            <select class="form-select" id="imagingCategory">
                                <option value="">All categories</option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label small text-muted" for="imagingPerPage">Per page</label>
                            <select class="form-select" id="imagingPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="col-lg-2 d-grid">
                            <button class="btn btn-outline-secondary" id="imagingRefresh" type="button">Refresh</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Imaging</th>
                                    <th>Type</th>
                                    <th>Length</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="imagingTableBody"></tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <small class="text-muted" id="imagingMeta">Loading imaging library.</small>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Imaging pagination">
                            <button class="btn btn-outline-secondary" id="imagingPrev" type="button">Prev</button>
                            <button class="btn btn-outline-secondary" id="imagingNext" type="button">Next</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-secondary small mt-3 mb-0" id="queueStatus">Queue ready.</div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Queue Builder</div>
                <div class="card-body">
                    <p class="text-muted small">Upcoming items staged for the next 30 minutes.</p>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Type</th>
                                    <th>Length</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Weather Update</td>
                                    <td>Voice</td>
                                    <td>00:45</td>
                                    <td>Host live read</td>
                                </tr>
                                <tr>
                                    <td>Community PSA: Food Drive</td>
                                    <td>PSA</td>
                                    <td>00:30</td>
                                    <td>Auto insert ready</td>
                                </tr>
                                <tr>
                                    <td>Station ID - Summer</td>
                                    <td>Imaging</td>
                                    <td>00:10</td>
                                    <td>Scheduled sweep</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-outline-secondary" type="button">Add Empty Slot</button>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">Voicetrack Studio</div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-outline-danger" type="button">Record Voicetrack</button>
                        <button class="btn btn-outline-secondary" type="button">Stop</button>
                        <button class="btn btn-outline-primary" type="button">Import File</button>
                        <input class="form-control" type="file" aria-label="Upload voicetrack">
                    </div>
                    <form class="row g-2">
                        <div class="col-12">
                            <label class="form-label">Segment Title</label>
                            <input class="form-control" type="text" placeholder="Late Night Break">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Host</label>
                            <input class="form-control" type="text" placeholder="DJ Name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Show</label>
                            <input class="form-control" type="text" placeholder="Show Name">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" rows="3" placeholder="Timing notes, sponsor reads, etc."></textarea>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary" type="button">Save Voicetrack</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% include '_footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const queueStatus = document.getElementById('queueStatus');
    const musicTableBody = document.getElementById('musicTableBody');
    const musicMeta = document.getElementById('musicMeta');
    const musicPrev = document.getElementById('musicPrev');
    const musicNext = document.getElementById('musicNext');
    const musicSearch = document.getElementById('musicSearch');
    const musicFolder = document.getElementById('musicFolder');
    const musicPerPage = document.getElementById('musicPerPage');
    const musicRefresh = document.getElementById('musicRefresh');

    const psaTableBody = document.getElementById('psaTableBody');
    const psaMeta = document.getElementById('psaMeta');
    const psaPrev = document.getElementById('psaPrev');
    const psaNext = document.getElementById('psaNext');
    const psaSearch = document.getElementById('psaSearch');
    const psaCategory = document.getElementById('psaCategory');
    const psaPerPage = document.getElementById('psaPerPage');
    const psaRefresh = document.getElementById('psaRefresh');

    const imagingTableBody = document.getElementById('imagingTableBody');
    const imagingMeta = document.getElementById('imagingMeta');
    const imagingPrev = document.getElementById('imagingPrev');
    const imagingNext = document.getElementById('imagingNext');
    const imagingSearch = document.getElementById('imagingSearch');
    const imagingCategory = document.getElementById('imagingCategory');
    const imagingPerPage = document.getElementById('imagingPerPage');
    const imagingRefresh = document.getElementById('imagingRefresh');

    const state = {
        music: {items: [], page: 1, perPage: 25, query: '', folder: ''},
        psa: {items: [], page: 1, perPage: 25, query: '', category: ''},
        imaging: {items: [], page: 1, perPage: 25, query: '', category: ''},
    };

    function updateQueueStatus(message, variant = 'secondary') {
        queueStatus.textContent = message;
        queueStatus.className = `alert alert-${variant} small mt-3 mb-0`;
    }

    function formatDuration(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined) return '—';
        const seconds = Math.round(Number(totalSeconds));
        if (Number.isNaN(seconds)) return '—';
        const minutes = Math.floor(seconds / 60);
        const remainder = String(seconds % 60).padStart(2, '0');
        return `${minutes}:${remainder}`;
    }

    function fallbackTitle(item) {
        if (item.title) return item.title;
        if (item.name) return item.name;
        const path = item.path || '';
        if (!path) return 'Untitled';
        const parts = path.split(/[\\/]/);
        return parts[parts.length - 1].replace(/\.[^/.]+$/, '');
    }

    async function enqueueItem(payload) {
        try {
            updateQueueStatus('Queueing item...', 'info');
            const res = await fetch('/api/playback/queue/enqueue', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (data.status !== 'ok') {
                updateQueueStatus('Unable to queue item. Please try again.', 'warning');
                return;
            }
            updateQueueStatus(`Queued: ${payload.title}`, 'success');
        } catch (err) {
            updateQueueStatus('Queue request failed.', 'danger');
        }
    }

    async function queueMusicItem(item) {
        const title = fallbackTitle(item);
        let cues = {};
        try {
            const cueRes = await fetch(`/api/music/cue?path=${encodeURIComponent(item.path)}`);
            const cueData = await cueRes.json();
            cues = cueData.cue || {};
        } catch (err) {
            cues = {};
        }
        await enqueueItem({
            type: 'music',
            title,
            artist: item.artist,
            duration: item.duration_seconds,
            metadata: {
                path: item.path,
                album: item.album,
                album_artist: item.album_artist,
                folder: item.folder,
                cues,
            },
        });
    }

    async function queueLibraryItem(item) {
        const title = fallbackTitle(item);
        await enqueueItem({
            type: item.kind,
            title,
            duration: item.duration,
            metadata: {
                token: item.token,
                url: item.url,
                category: item.category,
                library_category: item.library_category,
                cues: item.cues || {},
                kind: item.kind,
            },
        });
    }

    function renderMusicTable() {
        if (!state.music.items.length) {
            musicTableBody.innerHTML = '<tr><td colspan="5" class="text-muted">No music tracks found.</td></tr>';
            return;
        }
        musicTableBody.innerHTML = state.music.items.map((item, idx) => `
            <tr>
                <td>${fallbackTitle(item)}</td>
                <td>${item.artist || '—'}</td>
                <td>${item.album || '—'}</td>
                <td>${formatDuration(item.duration_seconds)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-action="queue-music" data-index="${idx}">
                        Add to Queue
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderLibraryTable(targetBody, items, emptyLabel, action) {
        if (!items.length) {
            targetBody.innerHTML = `<tr><td colspan="4" class="text-muted">${emptyLabel}</td></tr>`;
            return;
        }
        targetBody.innerHTML = items.map((item, idx) => `
            <tr>
                <td>${fallbackTitle(item)}</td>
                <td>${item.category || '—'}</td>
                <td>${formatDuration(item.duration)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-action="${action}" data-index="${idx}">
                        Add to Queue
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function loadMusic() {
        const params = new URLSearchParams({
            q: state.music.query || '%',
            page: state.music.page,
            per_page: state.music.perPage,
        });
        if (state.music.folder) {
            params.set('folder', state.music.folder);
        }
        try {
            const res = await fetch(`/api/music/search?${params.toString()}`);
            const data = await res.json();
            state.music.items = data.items || [];
            renderMusicTable();
            if (data.folders) {
                const current = state.music.folder;
                const options = ['<option value="">All folders</option>'];
                data.folders.filter(Boolean).sort().forEach(folder => {
                    options.push(`<option value="${folder}">${folder}</option>`);
                });
                musicFolder.innerHTML = options.join('');
                musicFolder.value = current;
            }
            const total = data.total || 0;
            const start = total ? ((data.page - 1) * data.per_page) + 1 : 0;
            const end = Math.min(total, data.page * data.per_page);
            musicMeta.textContent = total
                ? `Showing ${start}-${end} of ${total}`
                : 'No music tracks found.';
            musicPrev.disabled = data.page <= 1;
            musicNext.disabled = end >= total;
        } catch (err) {
            musicTableBody.innerHTML = '<tr><td colspan="5" class="text-danger">Unable to load music library.</td></tr>';
            musicMeta.textContent = 'Error loading music library.';
        }
    }

    async function loadMediaLibrary(kind, stateKey, targetBody, targetMeta, targetPrev, targetNext, targetCategory) {
        const payload = state[stateKey];
        const params = new URLSearchParams({
            page: payload.page,
            per_page: payload.perPage,
            kind,
        });
        if (payload.query) params.set('q', payload.query);
        if (payload.category) params.set('category', payload.category);
        try {
            const res = await fetch(`/api/psa/library?${params.toString()}`);
            const data = await res.json();
            payload.items = data.items || [];
            renderLibraryTable(
                targetBody,
                payload.items,
                `No ${kind} items found.`,
                `queue-${kind}`,
            );
            if (data.categories && targetCategory) {
                const current = payload.category;
                const options = ['<option value="">All categories</option>'];
                data.categories.forEach(cat => {
                    options.push(`<option value="${cat}">${cat}</option>`);
                });
                targetCategory.innerHTML = options.join('');
                targetCategory.value = current;
            }
            const total = data.total || 0;
            const start = total ? ((data.page - 1) * data.per_page) + 1 : 0;
            const end = Math.min(total, data.page * data.per_page);
            targetMeta.textContent = total
                ? `Showing ${start}-${end} of ${total}`
                : `No ${kind} items found.`;
            targetPrev.disabled = data.page <= 1;
            targetNext.disabled = end >= total;
        } catch (err) {
            targetBody.innerHTML = `<tr><td colspan="4" class="text-danger">Unable to load ${kind} library.</td></tr>`;
            targetMeta.textContent = `Error loading ${kind} library.`;
        }
    }

    let musicTimer = null;
    musicSearch.addEventListener('input', () => {
        if (musicTimer) clearTimeout(musicTimer);
        musicTimer = setTimeout(() => {
            state.music.query = musicSearch.value.trim();
            state.music.page = 1;
            loadMusic();
        }, 250);
    });
    musicFolder.addEventListener('change', () => {
        state.music.folder = musicFolder.value;
        state.music.page = 1;
        loadMusic();
    });
    musicPerPage.addEventListener('change', () => {
        state.music.perPage = Number(musicPerPage.value);
        state.music.page = 1;
        loadMusic();
    });
    musicRefresh.addEventListener('click', () => loadMusic());
    musicPrev.addEventListener('click', () => {
        if (state.music.page <= 1) return;
        state.music.page -= 1;
        loadMusic();
    });
    musicNext.addEventListener('click', () => {
        state.music.page += 1;
        loadMusic();
    });

    let psaTimer = null;
    psaSearch.addEventListener('input', () => {
        if (psaTimer) clearTimeout(psaTimer);
        psaTimer = setTimeout(() => {
            state.psa.query = psaSearch.value.trim();
            state.psa.page = 1;
            loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
        }, 250);
    });
    psaCategory.addEventListener('change', () => {
        state.psa.category = psaCategory.value;
        state.psa.page = 1;
        loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    });
    psaPerPage.addEventListener('change', () => {
        state.psa.perPage = Number(psaPerPage.value);
        state.psa.page = 1;
        loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    });
    psaRefresh.addEventListener('click', () => {
        loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    });
    psaPrev.addEventListener('click', () => {
        if (state.psa.page <= 1) return;
        state.psa.page -= 1;
        loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    });
    psaNext.addEventListener('click', () => {
        state.psa.page += 1;
        loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    });

    let imagingTimer = null;
    imagingSearch.addEventListener('input', () => {
        if (imagingTimer) clearTimeout(imagingTimer);
        imagingTimer = setTimeout(() => {
            state.imaging.query = imagingSearch.value.trim();
            state.imaging.page = 1;
            loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
        }, 250);
    });
    imagingCategory.addEventListener('change', () => {
        state.imaging.category = imagingCategory.value;
        state.imaging.page = 1;
        loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
    });
    imagingPerPage.addEventListener('change', () => {
        state.imaging.perPage = Number(imagingPerPage.value);
        state.imaging.page = 1;
        loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
    });
    imagingRefresh.addEventListener('click', () => {
        loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
    });
    imagingPrev.addEventListener('click', () => {
        if (state.imaging.page <= 1) return;
        state.imaging.page -= 1;
        loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
    });
    imagingNext.addEventListener('click', () => {
        state.imaging.page += 1;
        loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
    });

    musicTableBody.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-action="queue-music"]');
        if (!btn) return;
        const idx = Number(btn.dataset.index);
        const item = state.music.items[idx];
        if (!item) return;
        queueMusicItem(item);
    });

    psaTableBody.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-action="queue-psa"]');
        if (!btn) return;
        const idx = Number(btn.dataset.index);
        const item = state.psa.items[idx];
        if (!item) return;
        queueLibraryItem(item);
    });

    imagingTableBody.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-action="queue-imaging"]');
        if (!btn) return;
        const idx = Number(btn.dataset.index);
        const item = state.imaging.items[idx];
        if (!item) return;
        queueLibraryItem(item);
    });

    loadMusic();
    loadMediaLibrary('psa', 'psa', psaTableBody, psaMeta, psaPrev, psaNext, psaCategory);
    loadMediaLibrary('imaging', 'imaging', imagingTableBody, imagingMeta, imagingPrev, imagingNext, imagingCategory);
</script>
</body>
</html>
