<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Music Search & Bulk Tools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .browser-list {
            max-height: 360px;
            overflow-y: auto;
        }
        .browser-list .list-group-item {
            cursor: pointer;
        }
        .browser-list .list-group-item.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .browser-meta-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .metadata-cover {
            max-width: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
{% include '_nav.html' %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Music Library</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="scanBtn">Run duplicate/quality scan</button>
            <button class="btn btn-outline-primary btn-sm" id="queuesBtn">Refresh queues</button>
        </div>
    </div>
    <form class="row g-2 mb-3" id="searchForm">
        <div class="col-md-6">
            <input type="text" class="form-control" id="query" placeholder="Search title, artist, album, composer (use % to list all)" required aria-describedby="searchHelp">
            <small class="text-muted" id="searchHelp">Tip: enter % to show the entire library. Press Tab/Enter to move through results.</small>
            <div class="help-hint text-info">Need guidance? See the Music Search section in the API docs for filters and saved searches.</div>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
        <div class="col-md-3 d-flex gap-2 align-items-stretch">
            <button type="button" class="btn btn-outline-success w-100 h-100" id="saveSearchBtn">Save search</button>
            <div class="dropdown w-100">
                <button class="btn btn-outline-secondary dropdown-toggle w-100 h-100" type="button" data-bs-toggle="dropdown">Saved</button>
                <ul class="dropdown-menu" id="savedList"></ul>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <label class="form-label">Sort mode</label>
            <select id="sortMode" class="form-select">
                <option value="title">Title</option>
                <option value="artist">Artist → Album → Title</option>
                <option value="album">Album → Track</option>
                <option value="duration_seconds">Length</option>
            </select>
        </div>
        <div class="col-12 col-lg-4">
            <label class="form-label">Folder</label>
            <select id="folderFilter" class="form-select">
                <option value="">All folders</option>
            </select>
        </div>
        <div class="col-12 col-lg-3">
            <label class="form-label">Genre</label>
            <select id="genreFilter" class="form-select">
                <option value="">All genres</option>
            </select>
        </div>
        <div class="col-12 col-lg-3">
            <label class="form-label">Year</label>
            <select id="yearFilter" class="form-select">
                <option value="">All years</option>
            </select>
        </div>
        <div class="col-12 col-lg-3">
            <label class="form-label">Mood</label>
            <select id="moodFilter" class="form-select">
                <option value="">All moods</option>
            </select>
        </div>
        <div class="col-12 col-lg-3 d-flex align-items-end">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="explicitFilter">
                <label class="form-check-label" for="explicitFilter">Explicit only</label>
            </div>
        </div>
    </form>

    <div class="row g-3 mb-4">
        <div class="col-lg-9">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Library Browser</span>
                    <small class="text-muted">Use ↑↓ to move, ←→ to switch columns, Enter to open track.</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="browser-meta-label text-muted mb-1">Artists</div>
                            <div class="list-group browser-list" id="artistList" role="listbox" aria-label="Artists"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="browser-meta-label text-muted mb-1">Albums</div>
                            <div class="list-group browser-list" id="albumList" role="listbox" aria-label="Albums"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="browser-meta-label text-muted mb-1">Tracks</div>
                            <div class="list-group browser-list" id="trackList" role="listbox" aria-label="Tracks"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card h-100" id="metadataSidebar">
                <div class="card-header">Selection Metadata</div>
                <div class="card-body">
                    <div id="metadataBody" class="text-muted small">Select an artist, album, or track to see details.</div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-primary w-100" id="openDetailBtn" disabled>Open track detail</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <table class="table table-striped" id="resultsTable">
                <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th role="button" data-sort="title">Title</th>
                    <th role="button" data-sort="artist">Artist</th>
                    <th role="button" data-sort="album">Album</th>
                    <th role="button" data-sort="duration_seconds">Length</th>
                    <th>Cues</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small" id="resultsMeta">No results loaded.</div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Pagination">
                    <button class="btn btn-outline-secondary" id="prevPage">Prev</button>
                    <button class="btn btn-outline-secondary" id="nextPage">Next</button>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">Bulk Edit / Cover</div>
                <div class="card-body">
                    <div class="mb-2"><small class="text-muted">Applies to selected rows</small></div>
                    <div class="mb-2"><input class="form-control" name="title" placeholder="Title"></div>
                    <div class="mb-2"><input class="form-control" name="artist" placeholder="Artist"></div>
                    <div class="mb-2"><input class="form-control" name="album" placeholder="Album"></div>
                    <div class="mb-2"><input class="form-control" name="composer" placeholder="Composer"></div>
                    <div class="mb-2"><input class="form-control" name="isrc" placeholder="ISRC"></div>
                    <div class="mb-2"><input class="form-control" name="year" placeholder="Year"></div>
                    <div class="mb-2"><input class="form-control" name="track" placeholder="Track #"></div>
                    <div class="mb-2"><input class="form-control" name="disc" placeholder="Disc #"></div>
                    <div class="mb-3"><input class="form-control" type="file" id="cover" accept="image/*"></div>
                    <button class="btn btn-primary w-100" id="bulkApply" type="button">Apply to selected</button>
                    <div class="text-muted small mt-2" id="bulkStatus"></div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">Artists</div>
                <div class="card-body" id="artistList">
                    <p class="text-muted mb-0">Run a search to load artists.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">Albums</div>
                <div class="card-body" id="albumGrid">
                    <p class="text-muted mb-0">Run a search to load albums.</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Queues</div>
                <div class="card-body" id="queues">
                    <p class="text-muted mb-0">Click "Refresh queues" to load.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3" id="scanResults" style="display:none;">
        <div class="card-header">Duplicate / Quality Report</div>
        <div class="card-body">
            <div id="scanBody"></div>
        </div>
    </div>
</div>
{% include '_footer.html' %}
<script>
    const form = document.getElementById('searchForm');
    const tbody = document.querySelector('#resultsTable tbody');
    const selectAll = document.getElementById('selectAll');
    const queuesBox = document.getElementById('queues');
    const artistList = document.getElementById('artistList');
    const albumGrid = document.getElementById('albumGrid');
    let savedSearches = {{ saved_searches|default([])|tojson }};
    let resultsData = [];
    let selectedArtist = null;
    let selectedAlbum = null;
    let selectedTrackPath = null;
    let sortState = { key: null, dir: 1 };
    let currentPage = 1;
    let lastQuery = '';
    const perPage = 50;
    const folderFilter = document.getElementById('folderFilter');

    function renderSaved() {
        const list = document.getElementById('savedList');
        if (!list) return;
        if (!savedSearches.length) {
            list.innerHTML = '<li><span class="dropdown-item text-muted">No saved searches</span></li>';
            return;
        }
        list.innerHTML = savedSearches.map(s => `
            <li class="d-flex align-items-center">
              <a class="dropdown-item flex-grow-1" href="#" data-query="${s.query}">${s.name}</a>
              <button class="btn btn-link text-danger px-2 py-1" data-delete="${s.id}">×</button>
            </li>`).join('');
    }

    function buildSelectOptions(select, values, defaultLabel) {
        const current = select.value;
        const opts = [`<option value="">${defaultLabel}</option>`];
        values.forEach(val => {
            const safe = val || '';
            opts.push(`<option value="${safe}">${safe}</option>`);
        });
        if (current && !values.includes(current)) {
            opts.push(`<option value="${current}">${current}</option>`);
        }
        select.innerHTML = opts.join('');
        if (current) {
            select.value = current;
        }
    }

    function updateFilterOptions(payload) {
        buildSelectOptions(genreFilter, payload.genres || [], 'All genres');
        buildSelectOptions(yearFilter, payload.years || [], 'All years');
        buildSelectOptions(moodFilter, payload.moods || [], 'All moods');
    }

    function getArtists(items) {
        const map = new Map();
        items.forEach(item => {
            const value = item.artist || '';
            const label = item.artist || 'Unknown Artist';
            const entry = map.get(value) || { value, label, count: 0 };
            entry.count += 1;
            map.set(value, entry);
        });
        return Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label));
    }

    function getAlbums(items, artistValue) {
        const map = new Map();
        items.filter(item => (item.artist || '') === artistValue).forEach(item => {
            const value = item.album || '';
            const label = item.album || 'Unknown Album';
            const entry = map.get(value) || { value, label, count: 0 };
            entry.count += 1;
            map.set(value, entry);
        });
        return Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label));
    }

    function getTracks(items, artistValue, albumValue) {
        return items.filter(item => (item.artist || '') === artistValue && (item.album || '') === albumValue)
            .sort((a, b) => {
                const disc = (a.disc_num || 0) - (b.disc_num || 0);
                if (disc !== 0) return disc;
                const track = (a.track_num || 0) - (b.track_num || 0);
                if (track !== 0) return track;
                return (a.title || '').localeCompare(b.title || '');
            });
    }

    function renderList(container, items, selectedValue, type) {
        container.innerHTML = '';
        if (!items.length) {
            const empty = document.createElement('div');
            empty.className = 'text-muted small';
            empty.textContent = 'No results';
            container.appendChild(empty);
            return;
        }
        items.forEach(item => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            btn.dataset.type = type;
            btn.dataset.value = item.value;
            btn.textContent = item.label;
            if (item.count) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary rounded-pill';
                badge.textContent = item.count;
                btn.appendChild(badge);
            }
            if (selectedValue === item.value) {
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
            } else {
                btn.setAttribute('aria-selected', 'false');
            }
            container.appendChild(btn);
        });
    }

    function renderTrackList(container, tracks, selectedPath) {
        container.innerHTML = '';
        if (!tracks.length) {
            const empty = document.createElement('div');
            empty.className = 'text-muted small';
            empty.textContent = 'No tracks';
            container.appendChild(empty);
            return;
        }
        tracks.forEach(track => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.type = 'track';
            btn.dataset.path = track.path;
            const num = track.track_num ? `${track.track_num}. ` : '';
            btn.textContent = `${num}${track.title || 'Untitled'}`;
            if (selectedPath === track.path) {
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
            } else {
                btn.setAttribute('aria-selected', 'false');
            }
            container.appendChild(btn);
        });
    }

    function setSelectionDefaults() {
        const artists = getArtists(resultsData);
        if (!selectedArtist || !artists.find(a => a.value === selectedArtist)) {
            selectedArtist = artists.length ? artists[0].value : null;
        }
        const albums = selectedArtist ? getAlbums(resultsData, selectedArtist) : [];
        if (!selectedAlbum || !albums.find(a => a.value === selectedAlbum)) {
            selectedAlbum = albums.length ? albums[0].value : null;
        }
        const tracks = (selectedArtist && selectedAlbum) ? getTracks(resultsData, selectedArtist, selectedAlbum) : [];
        if (!selectedTrackPath || !tracks.find(t => t.path === selectedTrackPath)) {
            selectedTrackPath = tracks.length ? tracks[0].path : null;
        }
    }

    function updateMetadata() {
        if (!metadataBody) return;
        const artistLabel = selectedArtist || 'Unknown Artist';
        const albumLabel = selectedAlbum || 'Unknown Album';
        const track = resultsData.find(item => item.path === selectedTrackPath);
        const artistTracks = selectedArtist ? resultsData.filter(item => (item.artist || '') === selectedArtist) : [];
        const albumTracks = selectedArtist && selectedAlbum
            ? resultsData.filter(item => (item.artist || '') === selectedArtist && (item.album || '') === selectedAlbum)
            : [];

        let html = `
            <div class="browser-meta-label text-muted">Artist</div>
            <div class="fw-semibold mb-2">${artistLabel}</div>
            <div class="browser-meta-label text-muted">Album</div>
            <div class="fw-semibold mb-3">${albumLabel}</div>
            <div class="d-flex justify-content-between mb-2"><span>Albums</span><span>${new Set(artistTracks.map(t => t.album || 'Unknown Album')).size || 0}</span></div>
            <div class="d-flex justify-content-between mb-3"><span>Tracks</span><span>${artistTracks.length}</span></div>
        `;

        if (track) {
            const explicitLabel = track.explicit === true ? 'Yes' : track.explicit === false ? 'No' : 'Unknown';
            html = `
                <div class="text-center mb-3">
                    <img class="metadata-cover mb-2" src="/music/cover?path=${encodeURIComponent(track.path)}" alt="cover">
                </div>
                <div class="browser-meta-label text-muted">Track</div>
                <div class="fw-semibold mb-2">${track.title || 'Untitled'}</div>
                <div class="small mb-1"><strong>Artist:</strong> ${track.artist || 'Unknown'}</div>
                <div class="small mb-1"><strong>Album:</strong> ${track.album || 'Unknown'}</div>
                <div class="small mb-1"><strong>Year:</strong> ${track.year || '—'}</div>
                <div class="small mb-1"><strong>Genre:</strong> ${track.genre || '—'}</div>
                <div class="small mb-1"><strong>Mood:</strong> ${track.mood || '—'}</div>
                <div class="small mb-1"><strong>Explicit:</strong> ${explicitLabel}</div>
                <div class="small mb-1"><strong>Length:</strong> ${track.duration_seconds ? track.duration_seconds.toFixed(1) + 's' : '—'}</div>
                <div class="small"><strong>Folder:</strong> ${track.folder || '—'}</div>
            `;
        }
        metadataBody.innerHTML = html;
        if (openDetailBtn) {
            openDetailBtn.disabled = !track;
            openDetailBtn.dataset.path = track ? track.path : '';
        }
    }

    function renderBrowser() {
        setSelectionDefaults();
        const artists = getArtists(resultsData);
        const albums = selectedArtist ? getAlbums(resultsData, selectedArtist) : [];
        const tracks = (selectedArtist && selectedAlbum) ? getTracks(resultsData, selectedArtist, selectedAlbum) : [];
        renderList(artistList, artists, selectedArtist, 'artist');
        renderList(albumList, albums, selectedAlbum, 'album');
        renderTrackList(trackList, tracks, selectedTrackPath);
        updateMetadata();
        document.querySelectorAll('.result-row').forEach(row => {
            row.classList.toggle('table-active', row.dataset.path === selectedTrackPath);
        });
    }

    function renderResults(data) {
        resultsData = data.slice();
        tbody.innerHTML = data.map(item => `
            <tr class="result-row" tabindex="0" data-path="${item.path}">
                <td><input type="checkbox" value="${item.path}" aria-label="Select ${item.title || 'track'}"></td>
                <td><a href="/music/detail?path=${encodeURIComponent(item.path)}">${item.title || ''}</a></td>
                <td>${item.artist || ''}</td>
                <td>${item.album || ''}</td>
                <td>${item.duration_seconds ? item.duration_seconds.toFixed(1)+'s' : ''}</td>
                <td>${formatCues(item.cues)}</td>
                <td class="d-flex gap-1 flex-wrap">
                    <a class="btn btn-outline-secondary btn-sm" href="/music/edit?path=${encodeURIComponent(item.path)}">Edit</a>
                    <a class="btn btn-outline-primary btn-sm" href="/music/cue?path=${encodeURIComponent(item.path)}">Cue Editor</a>
                </td>
            </tr>
        `).join('');
        document.querySelectorAll('.result-row').forEach(row => {
            row.addEventListener('keydown', (ev) => {
                if (ev.key === ' ' || ev.key === 'Spacebar') {
                    ev.preventDefault();
                    const cb = row.querySelector('input[type=checkbox]');
                    if (cb) { cb.checked = !cb.checked; }
                }
                if (ev.key === 'Enter') {
                    const link = row.querySelector('a');
                    if (link) { link.click(); }
                }
            });
            row.addEventListener('click', (ev) => {
                if (ev.target && ev.target.matches('input[type=checkbox]')) {
                    return;
                }
                selectTrack(row.dataset.path);
            });
        });
        renderArtistsAndAlbums(resultsData);
    }

    function selectArtist(value) {
        selectedArtist = value;
        selectedAlbum = null;
        selectedTrackPath = null;
        renderBrowser();
    }

    function selectAlbum(value) {
        selectedAlbum = value;
        selectedTrackPath = null;
        renderBrowser();
    }

    function selectTrack(path) {
        selectedTrackPath = path;
        renderBrowser();
    }

    function moveFocus(list, direction) {
        const items = Array.from(list.querySelectorAll('button.list-group-item'));
        if (!items.length) return;
        const active = document.activeElement;
        const currentIndex = items.indexOf(active);
        let nextIndex = currentIndex + direction;
        if (currentIndex === -1) {
            nextIndex = 0;
        }
        nextIndex = Math.max(0, Math.min(items.length - 1, nextIndex));
        items[nextIndex].focus();
    }

    function focusNeighborList(current, direction) {
        const lists = [artistList, albumList, trackList];
        const idx = lists.indexOf(current);
        const nextIdx = idx + direction;
        if (nextIdx >= 0 && nextIdx < lists.length) {
            const nextList = lists[nextIdx];
            const firstItem = nextList.querySelector('button.list-group-item');
            if (firstItem) {
                firstItem.focus();
            }
        }
    }

    function handleListClick(event) {
        const btn = event.target.closest('button.list-group-item');
        if (!btn) return;
        if (btn.dataset.type === 'artist') {
            selectArtist(btn.dataset.value);
        } else if (btn.dataset.type === 'album') {
            selectAlbum(btn.dataset.value);
        } else if (btn.dataset.type === 'track') {
            selectTrack(btn.dataset.path);
        }
    }

    function handleListKeydown(event) {
        const list = event.currentTarget;
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            moveFocus(list, 1);
        }
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            moveFocus(list, -1);
        }
        if (event.key === 'ArrowRight') {
            event.preventDefault();
            focusNeighborList(list, 1);
        }
        if (event.key === 'ArrowLeft') {
            event.preventDefault();
            focusNeighborList(list, -1);
        }
        if (event.key === 'Enter' || event.key === ' ') {
            const btn = document.activeElement;
            if (btn && btn.classList.contains('list-group-item')) {
                btn.click();
                if (btn.dataset.type === 'track') {
                    window.location.href = `/music/detail?path=${encodeURIComponent(btn.dataset.path)}`;
                }
            }
        }
    }

    [artistList, albumList, trackList].forEach(list => {
        list.addEventListener('click', handleListClick);
        list.addEventListener('keydown', handleListKeydown);
    });

    renderSaved();

    function formatCues(cues) {
        if (!cues) return '<span class="text-muted">None</span>';
        const pairs = [];
        if (cues.cue_in != null) pairs.push(`In ${cues.cue_in.toFixed(1)}s`);
        if (cues.intro != null) pairs.push(`Intro ${cues.intro.toFixed(1)}s`);
        if (cues.start_next != null) pairs.push(`Next ${cues.start_next.toFixed(1)}s`);
        if (cues.outro != null) pairs.push(`Outro ${cues.outro.toFixed(1)}s`);
        if (cues.cue_out != null) pairs.push(`Out ${cues.cue_out.toFixed(1)}s`);
        return pairs.length ? pairs.join('<br>') : '<span class="text-muted">None</span>';
    }

    function renderArtistsAndAlbums(data) {
        if (!artistList || !albumGrid) return;
        if (!data.length) {
            artistList.innerHTML = '<p class="text-muted mb-0">No artists loaded.</p>';
            albumGrid.innerHTML = '<p class="text-muted mb-0">No albums loaded.</p>';
            return;
        }
        const artists = new Map();
        const albums = new Map();
        data.forEach(item => {
            const artist = item.artist || 'Unknown Artist';
            const album = item.album || 'Unknown Album';
            artists.set(artist, (artists.get(artist) || 0) + 1);
            const albumKey = `${artist}||${album}`;
            if (!albums.has(albumKey)) {
                albums.set(albumKey, {
                    artist,
                    album,
                    path: item.path,
                });
            }
        });
        const artistItems = Array.from(artists.entries()).sort((a, b) => a[0].localeCompare(b[0]));
        artistList.innerHTML = `<ul class="list-unstyled mb-0">${artistItems.map(([artist, count]) => `
            <li class="mb-1"><strong>${artist}</strong> <span class="text-muted">(${count})</span></li>
        `).join('')}</ul>`;
        const albumItems = Array.from(albums.values()).sort((a, b) => {
            const artistCmp = a.artist.localeCompare(b.artist);
            if (artistCmp !== 0) return artistCmp;
            return a.album.localeCompare(b.album);
        });
        albumGrid.innerHTML = `<div class="d-grid gap-2">${albumItems.map((item) => {
            const coverUrl = `/music/cover?path=${encodeURIComponent(item.path)}`;
            return `
            <div class="d-flex gap-2 align-items-center">
                <img src="${coverUrl}" alt="${item.album} cover" width="48" height="48" class="rounded border"
                    onerror="this.style.display='none'">
                <div>
                    <div class="fw-semibold">${item.album}</div>
                    <div class="text-muted small">${item.artist}</div>
                </div>
            </div>`;
        }).join('')}</div>`;
    }

    function applySort(key) {
        if (!key) return;
        if (sortState.key === key) {
            sortState.dir *= -1;
        } else {
            sortState = { key, dir: 1 };
        }
        const sorted = resultsData.slice().sort((a, b) => {
            const av = a[key] || '';
            const bv = b[key] || '';
            if (key === 'artist') {
                return (a.artist || '').localeCompare(b.artist || '') || (a.album || '').localeCompare(b.album || '') || (a.title || '').localeCompare(b.title || '');
            }
            if (key === 'album') {
                return (a.album || '').localeCompare(b.album || '') || ((a.track || 0) - (b.track || 0));
            }
            if (typeof av === 'number' && typeof bv === 'number') {
                return (av - bv) * sortState.dir;
            }
            return av.toString().localeCompare(bv.toString()) * sortState.dir;
        });
        renderResults(sorted);
    }

    document.querySelectorAll('#resultsTable thead [data-sort]').forEach(th => {
        th.addEventListener('click', () => applySort(th.dataset.sort));
        th.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                applySort(th.dataset.sort);
            }
        });
        th.tabIndex = 0;
    });

    document.getElementById('sortMode').addEventListener('change', (e) => {
        const key = e.target.value;
        applySort(key);
    });

    document.getElementById('savedList').addEventListener('click', async (e) => {
        const load = e.target.getAttribute('data-query');
        const delId = e.target.getAttribute('data-delete');
        if (load) {
            e.preventDefault();
            document.getElementById('query').value = load;
            form.requestSubmit();
        }
        if (delId) {
            e.preventDefault();
            await fetch(`/api/music/saved-searches?id=${delId}`, {method: 'DELETE'});
            savedSearches = savedSearches.filter(s => s.id != delId);
            renderSaved();
        }
    });

    document.getElementById('saveSearchBtn').addEventListener('click', async () => {
        const q = document.getElementById('query').value.trim();
        if (!q) return;
        const name = prompt('Name this search?', q.slice(0, 30) || 'Saved search');
        if (!name) return;
        const res = await fetch('/api/music/saved-searches', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, query: q})
        });
        const data = await res.json();
        if (data.status === 'ok') {
            savedSearches.unshift({id: data.id, name, query: q});
            renderSaved();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = document.getElementById('query').value.trim();
        if (!q) return;
        currentPage = 1;
        lastQuery = q;
        await fetchPage();
    });

    async function fetchPage() {
        if (!lastQuery) return;
        const folder = folderFilter.value || '';
        const genre = genreFilter.value || '';
        const year = yearFilter.value || '';
        const mood = moodFilter.value || '';
        const explicitOnly = explicitFilter.checked;
        const params = new URLSearchParams({
            q: lastQuery,
            page: currentPage,
            per_page: perPage,
        });
        if (folder) params.set('folder', folder);
        if (genre) params.set('genre', genre);
        if (year) params.set('year', year);
        if (mood) params.set('mood', mood);
        if (explicitOnly) params.set('explicit', '1');
        const res = await fetch(`/api/music/search?${params.toString()}`);
        const data = await res.json();
        renderResults(data.items || []);
        updateFilterOptions(data);
        if (data.folders) {
            const opts = ['<option value="">All folders</option>'];
            data.folders.filter(Boolean).sort().forEach(f => {
                opts.push(`<option value="${f}">${f}</option>`);
            });
            folderFilter.innerHTML = opts.join('');
            if (folder) folderFilter.value = folder;
        }
        const total = data.total || 0;
        const start = total ? ((data.page - 1) * data.per_page) + 1 : 0;
        const end = Math.min(total, data.page * data.per_page);
        document.getElementById('resultsMeta').textContent = total
            ? `Showing ${start}-${end} of ${total}`
            : 'No results found.';
        document.getElementById('prevPage').disabled = data.page <= 1;
        document.getElementById('nextPage').disabled = end >= total;
    }

    document.getElementById('prevPage').addEventListener('click', async () => {
        if (currentPage <= 1) return;
        currentPage -= 1;
        await fetchPage();
    });
    document.getElementById('nextPage').addEventListener('click', async () => {
        currentPage += 1;
        await fetchPage();
    });
    folderFilter.addEventListener('change', async () => {
        currentPage = 1;
        await fetchPage();
    });
    genreFilter.addEventListener('change', async () => {
        currentPage = 1;
        await fetchPage();
    });
    yearFilter.addEventListener('change', async () => {
        currentPage = 1;
        await fetchPage();
    });
    moodFilter.addEventListener('change', async () => {
        currentPage = 1;
        await fetchPage();
    });
    explicitFilter.addEventListener('change', async () => {
        currentPage = 1;
        await fetchPage();
    });

    selectAll.addEventListener('change', () => {
        document.querySelectorAll('#resultsTable tbody input[type=checkbox]').forEach(cb => {
            cb.checked = selectAll.checked;
        });
    });

    openDetailBtn.addEventListener('click', () => {
        const path = openDetailBtn.dataset.path;
        if (path) {
            window.location.href = `/music/detail?path=${encodeURIComponent(path)}`;
        }
    });

    document.getElementById('bulkApply').addEventListener('click', async () => {
        const paths = Array.from(document.querySelectorAll('#resultsTable tbody input[type=checkbox]:checked')).map(cb => cb.value);
        if (!paths.length) {
            document.getElementById('bulkStatus').textContent = 'Select at least one track.';
            return;
        }
        const updates = {};
        document.querySelectorAll('.card-body input.form-control').forEach(inp => {
            if (inp.name) { updates[inp.name] = inp.value; }
        });
        let coverArt = null;
        const coverFile = document.getElementById('cover').files[0];
        if (coverFile) {
            const buf = await coverFile.arrayBuffer();
            coverArt = btoa(String.fromCharCode(...new Uint8Array(buf)));
        }
        const res = await fetch('/api/music/bulk-update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({paths, updates, cover_art: coverArt})
        });
        const data = await res.json();
        document.getElementById('bulkStatus').textContent = JSON.stringify(data);
    });

    async function loadQueues() {
        const res = await fetch('/api/music/scan/library');
        const data = await res.json();
        const metrics = data.metrics || {};
        const renderList = (arr, label) => `<div class="mb-2"><strong>${label}</strong><br>${arr.slice(0,5).map(t => t.title || t.path).join('<br>') || 'None'}</div>`;
        queuesBox.innerHTML = [
            renderList(metrics.recently_added || [], 'Recently Added'),
            renderList(metrics.needs_metadata || [], 'Needs metadata'),
            renderList(metrics.missing_art || [], 'Missing cover art'),
            renderList(metrics.low_bitrate || [], 'Low bitrate'),
        ].join('');
        return data;
    }

    document.getElementById('queuesBtn').addEventListener('click', loadQueues);

    document.getElementById('scanBtn').addEventListener('click', async () => {
        const data = await loadQueues();
        const metrics = data.metrics || {};
        const dupes = metrics.duplicates || [];
        const target = document.getElementById('scanBody');
        target.innerHTML = '';
        if (dupes.length) {
            target.innerHTML += '<h6>Duplicates</h6>' + dupes.map(pair => `<div>${pair[0].title || pair[0].path} == ${pair[1].title || pair[1].path}</div>`).join('');
        } else {
            target.innerHTML += '<div>No duplicates found.</div>';
        }
        document.getElementById('scanResults').style.display = 'block';
    });
</script>
</body>
</html>
