<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Submit Station Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
{% include '_nav.html' %}
<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mt-2">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <h2 class="mb-3">Station Log Submission</h2>
    <form method="post" id="logForm">
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">DJ First Name</label>
                <input type="text" class="form-control" name="dj_first_name" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">DJ Last Name</label>
                <input type="text" class="form-control" name="dj_last_name" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Show Name</label>
                <input type="text" class="form-control" name="show_name" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Show Date</label>
                <input type="date" class="form-control" name="show_date" value="{{ now.date() }}" required>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Entries</h5>
        </div>

        <div id="rows"></div>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-secondary btn-sm" id="addRow">Add Row</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearRows">Clear</button>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Submit Log</button>
    </form>
</div>

<template id="rowTemplate">
    <div class="row g-2 align-items-end mb-2 log-row" data-idx="">
        <input type="hidden" name="row_index" value="">
        <div class="col-md-2">
            <label class="form-label">Time</label>
            <div class="input-group">
                <input type="time" class="form-control" name="time_" required>
                <button class="btn btn-outline-secondary btn-now" type="button">Now</button>
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label">Type</label>
            <select class="form-select" name="type_" required>
                <option value="music">Music</option>
                <option value="psa">PSA</option>
                <option value="live_read">Live Read</option>
                <option value="event">Event</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Title / Description</label>
            <input type="text" class="form-control" name="title_" required>
        </div>
        <div class="col-md-3">
            <label class="form-label">Artist (music only)</label>
            <input list="artistSuggestions" class="form-control artist-input" name="artist_">
        </div>
        <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-remove">X</button>
        </div>
    </div>
</template>
<datalist id="artistSuggestions"></datalist>

<script>
    const STORAGE_KEY = 'wlmc_log_rows_v1';
    let counter = 0;
    const rowsContainer = document.getElementById('rows');
    const template = document.getElementById('rowTemplate').content;
    const artistSuggestions = document.getElementById('artistSuggestions');

    function loadSuggestions() {
        const data = JSON.parse(localStorage.getItem('wlmc_artists') || '[]');
        artistSuggestions.innerHTML = data.map(a => `<option value="${a}"></option>`).join('');
    }

    function saveSuggestions(newArtist) {
        if (!newArtist) return;
        const data = JSON.parse(localStorage.getItem('wlmc_artists') || '[]');
        if (!data.includes(newArtist)) {
            data.push(newArtist);
            localStorage.setItem('wlmc_artists', JSON.stringify(data));
            loadSuggestions();
        }
    }

    function addRow(data) {
        const clone = document.importNode(template, true);
        const row = clone.querySelector('.log-row');
        const idx = counter++;
        row.dataset.idx = idx;
        row.querySelector('input[name="row_index"]').value = idx;
        row.querySelectorAll('[name]').forEach(el => {
            if (el.name.endsWith('_')) {
                el.name = el.name + idx;
            }
        });
        rowsContainer.appendChild(clone);
        if (data) {
            row.querySelector(`[name="time_${idx}"]`).value = data.time || '';
            row.querySelector(`[name="type_${idx}"]`).value = data.type || 'music';
            row.querySelector(`[name="title_${idx}"]`).value = data.title || '';
            row.querySelector(`[name="artist_${idx}"]`).value = data.artist || '';
            handleTypeDisable(row.querySelector(`[name="type_${idx}"]`));
        }
    }

    document.getElementById('addRow').addEventListener('click', () => addRow());
    document.getElementById('clearRows').addEventListener('click', () => {
        rowsContainer.innerHTML = '';
        counter = 0;
        persistRows();
        addRow(); addRow(); addRow();
    });

    rowsContainer.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-remove')) {
            e.target.closest('.log-row').remove();
            persistRows();
        }
        if (e.target.classList.contains('btn-now')) {
            const input = e.target.closest('.input-group').querySelector('input[type="time"]');
            const now = new Date();
            input.value = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: false});
        }
    });

    function handleTypeDisable(selectEl) {
        const row = selectEl.closest('.log-row');
        const artistInput = row.querySelector('.artist-input');
        if (selectEl.value !== 'music') {
            artistInput.value = '';
            artistInput.disabled = true;
        } else {
            artistInput.disabled = false;
        }
    }

    rowsContainer.addEventListener('change', function (e) {
        if (e.target.name && e.target.name.startsWith('type_')) {
            handleTypeDisable(e.target);
        }
        if (e.target.classList.contains('artist-input')) {
            saveSuggestions(e.target.value.trim());
        }
        persistRows();
    });

    rowsContainer.addEventListener('input', persistRows);

    function persistRows() {
        const rows = Array.from(rowsContainer.querySelectorAll('.log-row')).map(row => {
            const idx = row.dataset.idx;
            return {
                time: row.querySelector(`[name="time_${idx}"]`).value,
                type: row.querySelector(`[name="type_${idx}"]`).value,
                title: row.querySelector(`[name="title_${idx}"]`).value,
                artist: row.querySelector(`[name="artist_${idx}"]`).value,
            };
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
    }

    function restoreRows() {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        rowsContainer.innerHTML = '';
        counter = 0;
        if (saved.length) {
            saved.forEach(r => addRow(r));
        } else {
            addRow(); addRow(); addRow();
        }
    }

    document.getElementById('logForm').addEventListener('submit', () => {
        localStorage.removeItem(STORAGE_KEY);
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && e.target.form?.matches('form')) {
            e.preventDefault();
            const focusable = Array.from(document.querySelectorAll('input, select, button')).filter(el => !el.disabled && el.offsetParent !== null);
            const idx = focusable.indexOf(document.activeElement);
            if (idx >= 0 && idx < focusable.length - 1) {
                focusable[idx + 1].focus();
            }
        }
    });

    loadSuggestions();
    restoreRows();
</script>
{% include '_footer.html' %}
</body>
</html>
