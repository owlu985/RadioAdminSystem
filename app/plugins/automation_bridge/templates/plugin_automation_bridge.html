{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Automation Bridge + RadioDJ</h2>
    <div class="text-muted">Rule-based inserts into RadioDJ</div>
  </div>

  <form class="card card-body mb-4" method="post">
    <h5 class="mb-3">New Rule</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Rule name</label>
        <input class="form-control" name="name" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Match tag (optional)</label>
        <input class="form-control" name="match_tag" placeholder="e.g. marathon">
      </div>
      <div class="col-md-3">
        <label class="form-label">Start time</label>
        <input class="form-control" type="time" name="start_time">
      </div>
      <div class="col-md-3">
        <label class="form-label">End time</label>
        <input class="form-control" type="time" name="end_time">
      </div>
      <div class="col-md-6">
        <label class="form-label">Days</label>
        <div class="d-flex flex-wrap gap-2">
          {% for d in ['mon','tue','wed','thu','fri','sat','sun'] %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="days" value="{{d}}" id="day_{{d}}">
            <label class="form-check-label" for="day_{{d}}">{{ d|capitalize }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label">RadioDJ track ID</label>
        <input class="form-control" name="radiodj_id" id="radiodj_id">
        <div class="form-text">Use search below or paste the ID.</div>
      </div>
      <div class="col-md-8">
        <label class="form-label">RadioDJ title (optional)</label>
        <input class="form-control" name="radiodj_title" id="radiodj_title">
      </div>
    </div>
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <button class="btn btn-primary" type="submit">Save rule</button>
      <div class="d-flex gap-2 align-items-center">
        <input class="form-control" placeholder="Search RadioDJ" id="rdj_q" style="max-width:220px;">
        <button class="btn btn-outline-secondary" type="button" id="btn-search">Search</button>
      </div>
    </div>
    <div class="mt-3" id="rdj_results" style="display:none;">
      <h6>Search results</h6>
      <ul class="list-group" id="rdj_results_list"></ul>
    </div>
  </form>

  <div class="card">
    <div class="card-header">Rules</div>
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead>
          <tr>
            <th>Name</th><th>Match</th><th>Window</th><th>RadioDJ</th><th>Enabled</th><th></th>
          </tr>
        </thead>
        <tbody>
        {% for r in rules %}
          <tr>
            <td>{{ r.name }}</td>
            <td>{{ r.match_tag or 'Any' }}{% if r.days_of_week %}<br><small class="text-muted">{{ r.days_of_week }}</small>{% endif %}</td>
            <td>{% if r.start_time %}{{ r.start_time.strftime('%H:%M') }} - {{ r.end_time.strftime('%H:%M') if r.end_time else 'end' }}{% else %}<span class="text-muted">Any</span>{% endif %}</td>
            <td>{{ r.radiodj_title or 'â€”' }}{% if r.radiodj_id %}<br><small class="text-muted">ID: {{ r.radiodj_id }}</small>{% endif %}</td>
            <td>
              <form method="post" action="{{ url_for('automation_bridge_plugin.toggle_rule', rule_id=r.id) }}">
                <button class="btn btn-sm {{ 'btn-success' if r.enabled else 'btn-outline-secondary' }}" type="submit">{{ 'Enabled' if r.enabled else 'Disabled' }}</button>
              </form>
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('automation_bridge_plugin.delete_rule', rule_id=r.id) }}" onsubmit="return confirm('Delete this rule?');">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="6" class="text-center text-muted py-3">No rules yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.getElementById('btn-search').addEventListener('click', async () => {
  const q = document.getElementById('rdj_q').value.trim();
  if (!q) return;
  const resp = await fetch(`/plugins/automation-bridge/radiodj/search?q=${encodeURIComponent(q)}`);
  const data = await resp.json();
  const list = document.getElementById('rdj_results_list');
  list.innerHTML = '';
  (data.results || []).forEach(item => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<div><strong>${item.title || item.Name || item.name || item.ID || ''}</strong><br><small class="text-muted">ID: ${item.id || item.ID || ''}</small></div>`;
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-outline-primary';
    btn.textContent = 'Use';
    btn.onclick = () => {
      document.getElementById('radiodj_id').value = item.id || item.ID || '';
      document.getElementById('radiodj_title').value = item.title || item.Name || item.name || '';
    };
    li.appendChild(btn);
    list.appendChild(li);
  });
  document.getElementById('rdj_results').style.display = 'block';
});
</script>
{% endblock %}
