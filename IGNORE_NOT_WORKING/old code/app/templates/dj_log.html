<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WLMC DJ Log</title>
<style>
body { font-family: sans-serif; padding: 1.5em; }
.row { display: flex; gap: 0.5em; margin-bottom: 0.5em; }
input, select, button { padding: 0.4em; font-size: 1em; }
input { width: 12em; }
.time { width: 4em; }
button { cursor: pointer; }
</style>
</head>
<body>

<h2>DJ Log</h2>

<div class="row">
  <input id="time_h" class="time" placeholder="HH" maxlength="2">
  :
  <input id="time_m" class="time" placeholder="MM" maxlength="2">
  <button onclick="setNow()">Now</button>
</div>

<div class="row">
  <select id="entry_type" onchange="updateFields()">
    <option value="music">Music</option>
    <option value="psa">PSA</option>
    <option value="event">Event</option>
  </select>
</div>

<div class="row">
  <input id="title" placeholder="Title / PSA Name / Event">
  <input id="artist" placeholder="Artist" list="artist_list">
</div>

<datalist id="artist_list"></datalist>

<div class="row">
  <input id="description" placeholder="Notes (optional)" style="width: 25em;">
</div>

<div class="row">
  <button onclick="submitEntry()">Submit</button>
  <button onclick="clearLog()">Clear</button>
</div>

<script>
const STORAGE_KEY = "wlmc_dj_log_draft";

function setNow() {
  const d = new Date();
  document.getElementById("time_h").value = String(d.getHours()).padStart(2, "0");
  document.getElementById("time_m").value = String(d.getMinutes()).padStart(2, "0");
  document.getElementById("title").focus();
}

function updateFields() {
  const type = entry_type.value;
  artist.style.display = (type === "music") ? "inline-block" : "none";
}

function saveDraft() {
  const data = {
    h: time_h.value,
    m: time_m.value,
    type: entry_type.value,
    title: title.value,
    artist: artist.value,
    desc: description.value
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadDraft() {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  time_h.value = data.h || "";
  time_m.value = data.m || "";
  entry_type.value = data.type || "music";
  title.value = data.title || "";
  artist.value = data.artist || "";
  description.value = data.desc || "";
  updateFields();
}

function clearLog() {
  if (!confirm("Clear current log entry?")) return;
  localStorage.removeItem(STORAGE_KEY);
  document.querySelectorAll("input").forEach(i => i.value = "");
}

async function submitEntry() {
  const h = time_h.value;
  const m = time_m.value;

  if (!h || !m || !title.value) {
    alert("Missing required fields.");
    return;
  }

  const timestamp = new Date();
  timestamp.setHours(h);
  timestamp.setMinutes(m);

  const payload = {
    timestamp: timestamp.toISOString(),
    entry_type: entry_type.value,
    title: title.value,
    artist: artist.value || null,
    description: description.value || null
  };

  try {
    const res = await fetch("/api/logs/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Submit failed");

    localStorage.removeItem(STORAGE_KEY);
    title.value = "";
    artist.value = "";
    description.value = "";
    title.focus();
  } catch (e) {
    alert("Error submitting log. Saved locally.");
  }
}

document.addEventListener("input", saveDraft);
document.addEventListener("DOMContentLoaded", loadDraft);

// HH â†’ MM auto advance
time_h.addEventListener("input", () => time_h.value.length === 2 && time_m.focus());
</script>

</body>
</html>
